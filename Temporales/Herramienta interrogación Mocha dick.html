<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Interrogación: Mocha Dick (Adaptativa V2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Lora:ital,wght@0;400;0;700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3 { font-family: 'Lora', serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">

        <header class="bg-white shadow-md rounded-xl p-6 mb-8 text-center border-l-4 border-blue-800">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Herramienta de Interrogación Adaptativa</h1>
            <p class="text-xl md:text-2xl text-gray-700 mt-2">"Mocha Dick" de Ortega y Martínez</p>
        </header>

        <!-- Pantalla de Inicio -->
        <div id="setup-screen" class="bg-white shadow-md rounded-xl p-8 max-w-lg mx-auto">
            <h2 class="text-2xl font-bold mb-6 text-center">Iniciar Nueva Evaluación</h2>
            <div class="space-y-4">
                <div>
                    <label for="student-name" class="block text-sm font-medium text-gray-700">Nombre del Estudiante</label>
                    <input type="text" id="student-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ej: Javiera Rojas">
                </div>
                <div>
                    <label for="student-course" class="block text-sm font-medium text-gray-700">Curso</label>
                    <input type="text" id="student-course" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ej: NM4-B">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Tipo de Evaluación (Adaptación)</label>
                    <div class="mt-2 grid grid-cols-2 gap-x-4 gap-y-2 bg-gray-50 p-3 rounded-md">
                        <label class="flex items-center">
                            <input type="radio" name="evaluation-type" value="regular" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                            <span class="ml-2 text-sm text-gray-600">Regular</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="evaluation-type" value="neet_general" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                            <span class="ml-2 text-sm text-gray-600">NEET (General)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="evaluation-type" value="neet_pia" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                            <span class="ml-2 text-sm text-gray-600">NEEP (PIA)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="evaluation-type" value="neet_4d" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                            <span class="ml-2 text-sm text-gray-600">NEEP 4D</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="mt-8">
                <button id="start-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Comenzar Interrogación
                </button>
            </div>
        </div>

        <!-- Pantalla de Interrogación -->
        <div id="interrogation-screen" class="hidden">
            <div class="bg-white shadow-md rounded-xl p-8">
                <div class="flex justify-between items-start border-b-2 pb-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">Evaluando a: <span id="eval-student-name" class="text-indigo-600"></span></h2>
                        <p class="text-gray-600">Curso: <span id="eval-student-course"></span></p>
                        <p id="eval-type-display" class="text-sm font-medium text-purple-700 mt-1"></p>
                    </div>
                    <div id="final-score-container" class="text-right">
                        <!-- El resultado se mostrará aquí -->
                    </div>
                </div>

                <h3 class="text-lg font-semibold mb-4">Preguntas Seleccionadas (Marcar puntaje y descartar una)</h3>
                <div id="questions-container" class="space-y-6">
                    <!-- Las preguntas se cargarán aquí dinámicamente -->
                </div>

                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button id="finalize-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Finalizar y Registrar Evaluación
                    </button>
                    <button id="cancel-button" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>

        <!-- Pantalla de Resultados -->
        <div id="results-screen" class="mt-12">
            <div class="bg-white shadow-md rounded-xl p-8">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Registro de Evaluaciones</h2>
                    <div class="flex gap-2 mt-4 sm:mt-0">
                        <button id="export-json" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Guardar Avance (JSON)</button>
                        <label for="import-json" class="cursor-pointer py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700">
                            Cargar Avance (JSON)
                            <input type="file" id="import-json" class="hidden" accept=".json">
                        </label>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estudiante</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Curso</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Puntaje Final</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nota</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Los resultados se agregarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal para Respuesta Ideal -->
    <div id="answer-modal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-xl font-bold">Respuesta Ideal</h3>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <div id="modal-question" class="font-semibold mb-2"></div>
                <div id="modal-answer" class="text-gray-700 prose"></div>
            </div>
        </div>
    </div>

    <script>
        // Database integration functions
        async function loadQuestionsFromDatabase() {
            try {
                const response = await fetch('/.netlify/functions/get-questions?toolName=moby_dick&limit=10');
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    return data.data.map(q => ({
                        id: q.id,
                        question: q.question_text,
                        level: q.difficulty_level,
                        category: q.category,
                        type: q.question_type
                    }));
                } else {
                    console.log('No questions found in database, using fallback');
                    return getFallbackQuestions();
                }
            } catch (error) {
                console.error('Error loading questions from database:', error);
                return getFallbackQuestions();
            }
        }

        async function saveEvaluationToDatabase(evaluationData) {
            try {
                const response = await fetch('/.netlify/functions/save-evaluation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        studentName: evaluationData.studentName,
                        studentCourse: evaluationData.studentCourse,
                        evaluationType: evaluationData.evalType,
                        toolName: 'moby_dick',
                        questionsData: evaluationData.questionsData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('Evaluación guardada en base de datos:', result);
                    alert(`Evaluación guardada correctamente. Puntaje final: ${result.finalScore.toFixed(1)}%`);
                    return result;
                } else {
                    console.error('Error saving evaluation:', result.error);
                    alert('Error al guardar la evaluación: ' + result.error);
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error saving evaluation:', error);
                alert('Error de conexión al guardar la evaluación');
                throw error;
            }
        }

        function getFallbackQuestions() {
            return [
                {
                    id: 1,
                    question: "¿Cuál es el nombre del barco en el que viaja Ismael?",
                    level: "easy",
                    category: "personajes",
                    type: "multiple_choice"
                },
                {
                    id: 2,
                    question: "¿Qué representa la ballena blanca en la novela?",
                    level: "hard",
                    category: "simbolismo",
                    type: "open_ended"
                },
                {
                    id: 3,
                    question: "¿Cuál es la profesión del narrador?",
                    level: "easy",
                    category: "narrador",
                    type: "multiple_choice"
                },
                {
                    id: 4,
                    question: "¿Cómo se llama el capitán del Pequod?",
                    level: "easy",
                    category: "personajes",
                    type: "multiple_choice"
                },
                {
                    id: 5,
                    question: "¿Qué simboliza el viaje del Pequod?",
                    level: "medium",
                    category: "simbolismo",
                    type: "open_ended"
                }
            ];
        }

        // --- BANCO DE PREGUNTAS Y RESPUESTAS ---
        const questionBank = [
             { id: 1, level: 'Básico', question: '¿En qué año y lugar comienza la narración del Caleb anciano?', answer: 'La narración del Caleb anciano comienza en Tomé, sur de Chile, en el año 1889.' },
            { id: 2, level: 'Básico', question: '¿Cómo se llama el primer barco ballenero en el que viaja Caleb y quién es su capitán?', answer: 'El barco se llama Dauphin y su capitán es Zimri Coffin.' },
            { id: 3, level: 'Básico', question: '¿Quién es Aliro Leftraru y cuál es su sueño?', answer: 'Es un joven mapuche, amigo de Caleb, que se embarca en el Dauphin. Su sueño es convertirse en un gran arponero.' },
            { id: 4, level: 'Básico', question: '¿A quiénes rescatan en el mar cerca de las Galápagos?', answer: 'Rescatan a los tres supervivientes del ballenero Essex: el capitán George Pollard, el primer oficial Owen Chase y el marinero Charles Ransdell.' },
            { id: 5, level: 'Básico', question: 'Según la historia inicial del Capitán Pollard, ¿qué le pasó a su sobrino Owen Coffin?', answer: 'Según Pollard, el joven Owen Coffin fue atrapado en las mandíbulas y devorado por la monstruosa ballena blanca que hundió el Essex.' },
            { id: 6, level: 'Básico', question: '¿Qué es un "Trempulcahue" según la abuela de Aliro, la Machi Rosa?', answer: 'Son cuatro ballenas sagradas que actúan como guardianas y transportan las almas de los muertos hacia la isla de Ngill Chenmaywe, el lugar de descanso final.' },
            { id: 7, level: 'Básico', question: '¿Cuál es la terrible verdad sobre la muerte de Owen Coffin que confiesa Owen Chase estando borracho?', answer: 'Confiesa que no se lo comió la ballena, sino que los supervivientes, enloquecidos por el hambre, lo mataron y practicaron canibalismo con su cuerpo.' },
            { id: 8, level: 'Básico', question: '¿Quién es Duncan Sheffield?', answer: 'Es un naturalista escocés que vive en Tirúa y se dedica a estudiar a las ballenas. Es un hombre de ciencia que respeta a estos animales.' },
            { id: 9, level: 'Básico', question: '¿Cómo se llama el segundo barco que se organiza para cazar a Mocha Dick y quién lo capitanea?', answer: 'El barco se llama Peleg Hawthorne y es comandado por el capitán Abel Macys.' },
            { id: 10, level: 'Básico', question: '¿Por qué Caleb y Aliro deciden embarcarse en el Peleg Hawthorne?', answer: 'Deciden embarcarse para proteger a Mocha Dick, ya que se enteran de que el capitán Macys ha aceptado una gran recompensa por matarla.' },
            { id: 11, level: 'Básico', question: '¿Quién es en realidad "Joe", el joven ayudante del Peleg Hawthorne?', answer: 'Joe es Josephine Macys, la hija del capitán, quien se disfraza de hombre para poder navegar y estar cerca de su padre.' },
            { id: 12, level: 'Básico', question: '¿Cuál es la verdadera historia sobre la muerte del padre de Caleb que Sheffield le revela?', answer: 'La familia de Caleb no era dueña de barcos, sino que su padre y abuelo eran arponeros. Su padre fue asesinado por otros balleneros al intentar proteger a la Mocha, y la ballena lo vengó.' },
            { id: 13, level: 'Básico', question: '¿Qué método cruel utiliza el capitán Macys para atraer a Mocha Dick cerca de la Isla Mocha?', answer: 'Ordena cazar a una madre ballena y a su cría, sabiendo que la ballena blanca, como protectora de su especie, vendrá a defenderlas.' },
            { id: 14, level: 'Básico', question: '¿Qué le sucede a Aliro Leftraru durante la batalla final?', answer: 'Es arrastrado al mar por la cuerda de un arpón y se presume que muere. Sin embargo, se sugiere que la ballena lo salva o lo lleva consigo.' },
            { id: 15, level: 'Básico', question: 'Al final del relato, ¿qué encuentra el Caleb anciano en la playa junto a la ballena varada?', answer: 'Encuentra una mano esquelética con un anillo que él reconoce: es la mano de su amigo Aliro Leftraru, confirmando su reencuentro final.' },
            { id: 16, level: 'Intermedio', question: 'Analiza la evolución de Caleb desde su motivación inicial de venganza hasta su decisión final.', answer: 'Caleb inicia su viaje creyendo una mentira, impulsado por una venganza heredada. A través del conocimiento (la confesión de Chase, la sabiduría de la Machi Rosa, la ciencia de Sheffield), su perspectiva cambia radicalmente. Pasa de ser un cazador a un protector, y su decisión final de no matar a la ballena representa la victoria de la verdad y su herencia cultural sobre el odio.' },
            { id: 17, level: 'Intermedio', question: 'Compara la visión de la naturaleza de los balleneros (como Macys) con la de Duncan Sheffield.', answer: 'Para Macys y los balleneros, la naturaleza es una fuente de recursos y riqueza, un enemigo a conquistar. Su relación es de explotación. Para Sheffield, la naturaleza es un objeto de estudio científico y maravilla. Su relación es de comprensión y respeto, buscando el conocimiento por sobre el lucro.' },
            { id: 18, level: 'Intermedio', question: '¿Qué simboliza el cuaderno de notas de Duncan Sheffield que Caleb hereda?', answer: 'El cuaderno simboliza el poder del conocimiento y la ciencia utilizados para el bien. Contiene datos objetivos sobre las ballenas que Caleb y Aliro usan para protegerlas, no para cazarlas. Representa una "arma" intelectual que contrarresta la fuerza bruta de los arpones.' },
            { id: 19, level: 'Intermedio', question: '¿Cómo se utiliza el lenguaje visual (el arte de Martínez) para mostrar la diferencia de escala entre los humanos y Mocha Dick?', answer: 'Se utilizan viñetas de página completa (splash pages) y ángulos de cámara contrapicados. En estas escenas, los botes y los hombres se ven diminutos en comparación con la inmensidad de la ballena. Esto enfatiza la insignificancia de la arrogancia humana frente al poder colosal de la naturaleza.' },
            { id: 20, level: 'Intermedio', question: '¿Qué representa el personaje de Josephine "Joe" Macys en la historia?', answer: 'Josephine representa la rebelión contra las normas sociales y de género de su época. Además, actúa como la conciencia de su padre y un puente entre el mundo de los balleneros y la causa de Caleb. Su conflicto interno entre la lealtad a su padre y lo que es correcto es central en la segunda mitad del libro.' },
            { id: 21, level: 'Intermedio', question: 'Analiza el conflicto entre la "historia oficial" (la del capitán Pollard) y la "verdad oculta" (la de Owen Chase).', answer: 'Este conflicto muestra cómo las narrativas se construyen para ocultar verdades vergonzosas. La historia oficial de Pollard es una mentira heroica para salvar su reputación y encubrir el horror del canibalismo. La verdad de Chase, revelada por el alcohol, expone la fragilidad de la moral "civilizada" en situaciones extremas.' },
            { id: 22, level: 'Intermedio', question: '¿Por qué el personaje de Aliro Leftraru debe "desaparecer" en la batalla final?', answer: 'La desaparición de Aliro tiene un fuerte peso simbólico. Se convierte en un mártir de la causa, un sacrificio que completa el ciclo mítico. Su "muerte" (o transformación) lo une definitivamente al mundo espiritual de la Mocha. Además, deja a Caleb como el único testigo humano, el único capaz de llevar la historia al mundo exterior, completando su rol como narrador y guardián de la leyenda.' },
            { id: 23, level: 'Intermedio', question: '¿Qué simboliza el Kurew, el pequeño barco de Duncan Sheffield?', answer: 'El Kurew ("Golondrina" en mapudungun) simboliza una alternativa a la violencia de los balleneros. Es un barco de investigación, no de caza. Su intervención en la batalla final, intentando salvar a la Mocha, representa la alianza entre la ciencia respetuosa y la sabiduría ancestral en defensa de la naturaleza.' },
            { id: 24, level: 'Intermedio', question: 'Analiza el uso del color en las escenas de la cosmogonía mapuche.', answer: 'Estas escenas, que narran el origen del mundo y la lucha entre los Hijos del Sol y los Hijos de la Tierra, utilizan una paleta de colores limitada, a menudo en tonos tierra, ocre y rojo. Este estilo visual las diferencia del resto de la narración, dándoles un aspecto de mural o arte rupestre, lo que refuerza su carácter mítico y ancestral.' },
            { id: 25, level: 'Intermedio', question: '¿Por qué el capitán Macys está tan obsesionado con la recompensa?', answer: 'Más allá del dinero, para Macys la recompensa representa la gloria y la consagración como el mejor ballenero. Su orgullo está en juego. La caza de la legendaria Mocha Dick es la oportunidad de inscribir su nombre en la historia, una ambición que lo ciega ante cualquier consideración moral o de seguridad.' }
        ];

        // --- DEFINICIÓN DE GRUPOS DE PREGUNTAS ---
        const neetGeneralQuestionIds = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25];
        const neepPiaQuestionIds = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 17, 18, 21, 22, 23, 24, 25];
        const neep4dQuestionIds = Array.from({length: 25}, (_, i) => i + 1);

        // --- ESTADO DE LA APLICACIÓN ---
        let evaluations = [];
        let currentEvaluation = {};

        // --- ELEMENTOS DEL DOM ---
        const setupScreen = document.getElementById('setup-screen');
        const interrogationScreen = document.getElementById('interrogation-screen');
        const resultsScreen = document.getElementById('results-screen');
        const studentNameInput = document.getElementById('student-name');
        const studentCourseInput = document.getElementById('student-course');
        const startButton = document.getElementById('start-button');
        const finalizeButton = document.getElementById('finalize-button');
        const cancelButton = document.getElementById('cancel-button');
        const questionsContainer = document.getElementById('questions-container');
        const resultsTableBody = document.getElementById('results-table-body');
        const exportJsonButton = document.getElementById('export-json');
        const importInput = document.getElementById('import-json');
        const modal = document.getElementById('answer-modal');
        const closeModalButton = document.getElementById('close-modal');

        // --- FUNCIONES DE AUTOGUARDADO ---
        function saveStateToLocalStorage() {
            try {
                localStorage.setItem('mochaDickEvaluations', JSON.stringify(evaluations));
                if (currentEvaluation && Object.keys(currentEvaluation).length > 0) {
                    localStorage.setItem('mochaDickCurrentEvaluation', JSON.stringify(currentEvaluation));
                } else {
                    localStorage.removeItem('mochaDickCurrentEvaluation');
                }
            } catch (error) {
                console.error("Error al guardar el estado:", error);
            }
        }

        function loadStateFromLocalStorage() {
            try {
                const savedEvaluations = localStorage.getItem('mochaDickEvaluations');
                if (savedEvaluations) {
                    evaluations = JSON.parse(savedEvaluations);
                    renderResultsTable();
                }

                const savedCurrentEvaluation = localStorage.getItem('mochaDickCurrentEvaluation');
                if (savedCurrentEvaluation) {
                    const restoredSession = JSON.parse(savedCurrentEvaluation);
                    if (restoredSession && restoredSession.questions && restoredSession.questions.length > 0) {
                        if (confirm('Se encontró una evaluación sin finalizar. ¿Deseas restaurarla?')) {
                            currentEvaluation = restoredSession;
                            document.getElementById('eval-student-name').textContent = currentEvaluation.studentName;
                            document.getElementById('eval-student-course').textContent = currentEvaluation.studentCourse;
                            const evalTypeDisplayNames = {
                                regular: "Regular",
                                neet_general: "NEET (General)",
                                neet_pia: "NEEP (PIA)",
                                neet_4d: "NEEP 4D"
                            };
                            document.getElementById('eval-type-display').textContent = `Tipo de Evaluación: ${evalTypeDisplayNames[currentEvaluation.evalType] || 'Regular'}`;
                            renderQuestions();
                            updateLiveScore();
                            setupScreen.classList.add('hidden');
                            interrogationScreen.classList.remove('hidden');
                        } else {
                            localStorage.removeItem('mochaDickCurrentEvaluation');
                        }
                    }
                }
            } catch (error) {
                console.error("Error al cargar el estado:", error);
                localStorage.removeItem('mochaDickEvaluations');
                localStorage.removeItem('mochaDickCurrentEvaluation');
            }
        }

        // --- LÓGICA PRINCIPAL ---
        startButton.addEventListener('click', async () => {
            const studentName = studentNameInput.value.trim();
            const studentCourse = studentCourseInput.value.trim();
            const evalType = document.querySelector('input[name="evaluation-type"]:checked').value;

            if (!studentName || !studentCourse) {
                alert('Por favor, completa todos los campos.');
                return;
            }

            // Intentar cargar preguntas desde la base de datos primero
            let availableQuestions = await loadQuestionsFromDatabase();

            // Si no hay preguntas en BD, usar las locales
            if (availableQuestions.length < 8) {
                availableQuestions = questionBank.filter(q => {
                    switch (evalType) {
                        case 'neet_general':
                            return neetGeneralQuestionIds.includes(q.id);
                        case 'neet_pia':
                            return neepPiaQuestionIds.includes(q.id);
                        case 'neet_4d':
                            return neep4dQuestionIds.includes(q.id);
                        default:
                            return true;
                    }
                });
            }

            if (availableQuestions.length < 8) {
                alert('No hay suficientes preguntas disponibles para esta evaluación.');
                return;
            }

            currentEvaluation = {
                id: Date.now(),
                studentName,
                studentCourse,
                evalType,
                questions: getRandomQuestions(8, availableQuestions),
                scores: {},
                excludedQuestion: null
            };

            saveStateToLocalStorage();

            document.getElementById('eval-student-name').textContent = studentName;
            document.getElementById('eval-student-course').textContent = studentCourse;

            const evalTypeDisplayNames = {
                regular: "Regular",
                neet_general: "NEET (General)",
                neet_pia: "NEEP (PIA)",
                neet_4d: "NEEP 4D"
            };
            document.getElementById('eval-type-display').textContent = `Tipo de Evaluación: ${evalTypeDisplayNames[evalType] || 'Regular'}`;

            renderQuestions();
            updateLiveScore();

            setupScreen.classList.add('hidden');
            interrogationScreen.classList.remove('hidden');
        });

        finalizeButton.addEventListener('click', async () => {
            const { score, grade } = calculateFinalScore();
            currentEvaluation.finalScore = score;
            currentEvaluation.finalGrade = grade;

            // Preparar datos para guardar en la base de datos
            const questionsData = currentEvaluation.questions.map(q => ({
                questionId: q.id,
                questionText: q.question,
                isCorrect: currentEvaluation.scores[q.id] === 1.0,
                score: currentEvaluation.scores[q.id] || 0,
                excluded: currentEvaluation.excludedQuestion === q.id
            }));

            try {
                // Intentar guardar en la base de datos
                await saveEvaluationToDatabase({
                    studentName: currentEvaluation.studentName,
                    studentCourse: currentEvaluation.studentCourse,
                    evalType: currentEvaluation.evalType,
                    questionsData: questionsData
                });

                // Si se guardó correctamente, agregar a la lista local
                evaluations.push(currentEvaluation);
                renderResultsTable();
                resetInterrogation();
            } catch (error) {
                console.error('Error saving to database:', error);
                // Si falla la BD, al menos guardar localmente
                evaluations.push(currentEvaluation);
                renderResultsTable();
                resetInterrogation();
                alert('Evaluación guardada localmente. Error al sincronizar con base de datos.');
            }
        });

        cancelButton.addEventListener('click', () => {
            if (confirm('¿Estás seguro de que quieres cancelar esta evaluación? El progreso no se guardará.')) {
                resetInterrogation();
            }
        });

        // --- FUNCIONES AUXILIARES ---
        function getRandomQuestions(count, questionArray) {
            const shuffled = [...questionArray].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function renderQuestions() {
            questionsContainer.innerHTML = '';
            currentEvaluation.questions.forEach((q, index) => {
                const questionId = `q-${q.id}`;
                const questionBlock = document.createElement('div');
                questionBlock.className = 'p-4 border rounded-lg bg-gray-50';
                questionBlock.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="font-semibold flex-1">${index + 1}. ${q.question} <span class="text-xs text-gray-500 font-normal">(${q.level})</span></p>
                        <button data-question-id="${q.id}" class="show-answer-btn ml-4 text-sm text-indigo-600 hover:underline flex-shrink-0">Ver Respuesta Ideal</button>
                    </div>
                    <div class="mt-3 flex items-center justify-between gap-4 flex-wrap">
                        <div class="flex items-center gap-4">
                            <span class="text-sm font-medium">Puntaje:</span>
                            <div class="flex gap-3">
                                ${[0, 0.5, 1.0].map(score => `
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="score-${questionId}" value="${score}" class="score-input" data-question-id="${q.id}">
                                        <span class="ml-1.5 text-sm">${score.toFixed(1)}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <div class="flex items-center">
                             <label class="flex items-center cursor-pointer">
                                <input type="radio" name="exclude-question" value="${q.id}" class="exclude-input">
                                <span class="ml-1.5 text-sm text-red-600 font-medium">Descartar</span>
                            </label>
                        </div>
                    </div>
                `;
                questionsContainer.appendChild(questionBlock);

                // Restaurar estado guardado
                const savedScore = currentEvaluation.scores[q.id];
                if (savedScore !== undefined) {
                    const scoreInput = questionBlock.querySelector(`input[name="score-${questionId}"][value="${savedScore}"]`);
                    if (scoreInput) scoreInput.checked = true;
                }
                if (currentEvaluation.excludedQuestion === q.id) {
                    const excludeInput = questionBlock.querySelector(`input[name="exclude-question"][value="${q.id}"]`);
                    if (excludeInput) excludeInput.checked = true;
                }
            });

            questionsContainer.querySelectorAll('.show-answer-btn').forEach(btn => {
                btn.addEventListener('click', () => showAnswerModal(btn.dataset.questionId));
            });

            // Agregar event listeners para scores y exclusions
            questionsContainer.querySelectorAll('.score-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const questionId = parseInt(e.target.dataset.questionId);
                    currentEvaluation.scores[questionId] = parseFloat(e.target.value);
                    updateLiveScore();
                    saveStateToLocalStorage();
                });
            });

            questionsContainer.querySelectorAll('.exclude-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const questionId = parseInt(e.target.value);
                    currentEvaluation.excludedQuestion = questionId;
                    updateLiveScore();
                    saveStateToLocalStorage();
                });
            });
        }

        function updateLiveScore() {
            const { score, grade } = calculateFinalScore();
            document.getElementById('final-score-container').innerHTML = `
                <p class="text-lg font-bold">Nota Parcial: <span class="text-green-600">${grade.toFixed(1)}</span></p>
                <p class="text-sm text-gray-500">Puntaje: ${score.toFixed(1)} / 7.0</p>
            `;
        }

        function calculateFinalScore() {
            let totalScore = 0;
            let validQuestions = 0;

            currentEvaluation.questions.forEach(q => {
                if (currentEvaluation.excludedQuestion !== q.id) {
                    const score = currentEvaluation.scores[q.id] || 0;
                    totalScore += score;
                    validQuestions++;
                }
            });

            const finalScore = validQuestions > 0 ? (totalScore / validQuestions) * 7 : 0;
            return { score: finalScore, grade: finalScore };
        }

        function resetInterrogation() {
            studentNameInput.value = '';
            studentCourseInput.value = '';
            currentEvaluation = {};
            interrogationScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            saveStateToLocalStorage();
        }

        function renderResultsTable() {
            resultsTableBody.innerHTML = '';
            evaluations.forEach(evalData => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${evalData.studentName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${evalData.studentCourse}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${evalData.evalType}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${evalData.finalScore.toFixed(1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${evalData.finalGrade.toFixed(1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="generatePDF(${evalData.id})" class="text-indigo-600 hover:text-indigo-900">PDF</button>
                    </td>
                `;
                resultsTableBody.appendChild(row);
            });
        }

        function showAnswerModal(questionId) {
            const question = questionBank.find(q => q.id == questionId);
            if (question) {
                document.getElementById('modal-question').textContent = question.question;
                document.getElementById('modal-answer').innerHTML = question.answer;
                modal.classList.remove('hidden');
                modal.classList.add('active');
            }
        }

        closeModalButton.addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('active');
        });

        // Función para generar PDF
        function generatePDF(evalId) {
            const evalData = evaluations.find(e => e.id === evalId);
            if (!evalData) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.text('Informe de Evaluación - Mocha Dick', 20, 30);

            doc.setFontSize(12);
            doc.text(`Estudiante: ${evalData.studentName}`, 20, 50);
            doc.text(`Curso: ${evalData.studentCourse}`, 20, 60);
            doc.text(`Tipo de Evaluación: ${evalData.evalType}`, 20, 70);
            doc.text(`Puntaje Final: ${evalData.finalScore.toFixed(1)}`, 20, 80);
            doc.text(`Nota: ${evalData.finalGrade.toFixed(1)}`, 20, 90);

            doc.save(`informe_${evalData.studentName.replace(/\s/g, '_')}.pdf`);
        }

        // Hacer la función global para el onclick
        window.generatePDF = generatePDF;

        // Cargar estado al iniciar
        window.addEventListener('DOMContentLoaded', loadStateFromLocalStorage);
    </script>
</body>
</html>

