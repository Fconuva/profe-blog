<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear tu Cuenta - ECEP 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .create-account-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            padding: 3rem;
            max-width: 500px;
            margin: 2rem auto;
            border: 1px solid #e5e7eb;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn-create {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            margin-top: 1rem;
        }

        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-create:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: none;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .password-strength {
            height: 4px;
            border-radius: 2px;
            background: #e5e7eb;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
        }

        .strength-weak { background: #ef4444; width: 33%; }
        .strength-medium { background: #f59e0b; width: 66%; }
        .strength-strong { background: #10b981; width: 100%; }

        .requirement {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .requirement.met {
            color: #10b981;
        }

        .requirement i {
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>

<div class="min-h-screen py-12">
    <div class="create-account-card">
        <div class="text-center mb-6">
            <div class="inline-block p-4 bg-green-100 rounded-full mb-4">
                <i class="fas fa-check-circle text-4xl text-green-600"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">¡Pago Confirmado!</h1>
            <p class="text-gray-600">Ahora crea tu cuenta para acceder a todos los contenidos ECEP 2025</p>
        </div>

        <div id="alert" class="alert">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="alertMessage"></span>
        </div>

        <form id="createAccountForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo</label>
                <input type="text" id="fullName" class="form-input" placeholder="Ej: María González" required>
                <p class="text-xs text-gray-500 mt-1">Tu nombre real para identificación</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Correo Electrónico</label>
                <input type="email" id="email" class="form-input" placeholder="tu@ejemplo.com" required>
                <p class="text-xs text-gray-500 mt-1">Tu correo electrónico de contacto</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de Usuario</label>
                <input type="text" id="username" class="form-input" placeholder="Ej: maria_gonzalez" required 
                       pattern="[a-zA-Z0-9_]{4,20}" minlength="4" maxlength="20">
                <p class="text-xs text-gray-500 mt-1">Solo letras, números y guion bajo. Mínimo 4 caracteres</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Contraseña</label>
                <div class="relative">
                    <input type="password" id="password" class="form-input" placeholder="Mínimo 8 caracteres" required minlength="8">
                    <button type="button" id="togglePassword" class="absolute right-3 top-4 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="password-strength">
                    <div id="strengthBar" class="password-strength-bar"></div>
                </div>
                <div class="space-y-1 mt-2">
                    <div class="requirement" id="req-length">
                        <i class="fas fa-circle text-xs"></i>Mínimo 8 caracteres
                    </div>
                    <div class="requirement" id="req-letter">
                        <i class="fas fa-circle text-xs"></i>Al menos una letra
                    </div>
                    <div class="requirement" id="req-number">
                        <i class="fas fa-circle text-xs"></i>Al menos un número
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Contraseña</label>
                <input type="password" id="confirmPassword" class="form-input" placeholder="Repite tu contraseña" required>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Acceso incluido:</strong> Todas las evaluaciones y dossieres de Educación Básica, Media y Parvularia ECEP 2025
                </p>
            </div>

            <button type="submit" id="createBtn" class="btn-create">
                <i class="fas fa-user-plus mr-2"></i>Crear Mi Cuenta
            </button>
        </form>

        <div class="text-center mt-6">
            <p class="text-sm text-gray-600">
                ¿Ya tienes cuenta? 
                <a href="/evaluaciones/login.html" class="text-pink-600 font-semibold hover:text-pink-700">
                    Inicia sesión aquí
                </a>
            </p>
        </div>
    </div>
</div>

<script>
// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyCzN4xNEE_hKshXbsVqLhWSnzet1pHwRh8",
    authDomain: "profe-blog.firebaseapp.com",
    databaseURL: "https://profe-blog-default-rtdb.firebaseio.com",
    projectId: "profe-blog",
    storageBucket: "profe-blog.firebasestorage.app",
    messagingSenderId: "305920739217",
    appId: "1:305920739217:web:2e08c7469d2988d8b3bc30"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Get payment info from URL params
const urlParams = new URLSearchParams(window.location.search);
const paymentId = urlParams.get('payment_id') || 'MANUAL_CREATION_' + Date.now();
const paymentStatus = urlParams.get('status') || 'approved';
const payerEmail = urlParams.get('email') || '';

// Pre-fill email if available
if (payerEmail) {
    document.getElementById('email').value = payerEmail;
}

// Note: Removed redirect validation to allow manual account creation

// Toggle password visibility
document.getElementById('togglePassword').addEventListener('click', function() {
    const passwordInput = document.getElementById('password');
    const icon = this.querySelector('i');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
});

// Password strength checker
document.getElementById('password').addEventListener('input', function() {
    const password = this.value;
    const strengthBar = document.getElementById('strengthBar');
    
    // Check requirements
    const hasLength = password.length >= 8;
    const hasLetter = /[a-zA-Z]/.test(password);
    const hasNumber = /\d/.test(password);
    
    // Update requirement indicators
    updateRequirement('req-length', hasLength);
    updateRequirement('req-letter', hasLetter);
    updateRequirement('req-number', hasNumber);
    
    // Update strength bar
    let strength = 0;
    if (hasLength) strength++;
    if (hasLetter) strength++;
    if (hasNumber) strength++;
    
    strengthBar.className = 'password-strength-bar';
    if (strength === 1) strengthBar.classList.add('strength-weak');
    else if (strength === 2) strengthBar.classList.add('strength-medium');
    else if (strength === 3) strengthBar.classList.add('strength-strong');
});

function updateRequirement(id, met) {
    const element = document.getElementById(id);
    const icon = element.querySelector('i');
    
    if (met) {
        element.classList.add('met');
        icon.classList.remove('fa-circle');
        icon.classList.add('fa-check-circle');
    } else {
        element.classList.remove('met');
        icon.classList.remove('fa-check-circle');
        icon.classList.add('fa-circle');
    }
}

// Form submission
document.getElementById('createAccountForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fullName = document.getElementById('fullName').value.trim();
    const email = document.getElementById('email').value.trim();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    const alert = document.getElementById('alert');
    const alertMessage = document.getElementById('alertMessage');
    const createBtn = document.getElementById('createBtn');
    
    // Validate passwords match
    if (password !== confirmPassword) {
        showAlert('Las contraseñas no coinciden', 'error');
        return;
    }
    
    // Validate password strength
    if (password.length < 8 || !/[a-zA-Z]/.test(password) || !/\d/.test(password)) {
        showAlert('La contraseña no cumple con los requisitos mínimos', 'error');
        return;
    }
    
    // Show loading
    createBtn.disabled = true;
    createBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creando cuenta...';
    
    try {
        // Check if username already exists
        const usersRef = database.ref('users');
        const snapshot = await usersRef.orderByChild('username').equalTo(username).once('value');
        
        if (snapshot.exists()) {
            showAlert('Este nombre de usuario ya está en uso. Por favor elige otro.', 'error');
            createBtn.disabled = false;
            createBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Crear Mi Cuenta';
            return;
        }
        
        // Check if email already has an account
        const emailSnapshot = await usersRef.orderByChild('email').equalTo(email).once('value');
        if (emailSnapshot.exists()) {
            showAlert('Ya existe una cuenta con este correo electrónico.', 'error');
            createBtn.disabled = false;
            createBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Crear Mi Cuenta';
            return;
        }
        
        // Create user account
        const newUserRef = usersRef.push();
        const passwordBase64 = btoa(password); // Base64 encoding
        
        const userData = {
            username: username,
            email: email,
            name: fullName,
            password: passwordBase64,
            role: 'cliente',
            permissions: { 
                basica: true, 
                media: true, 
                parvularia: true 
            },
            active: true,
            createdAt: new Date().toISOString(),
            sourcePaymentId: paymentId,
            plan: 'Acceso Completo ECEP 2025'
        };
        
        await newUserRef.set(userData);
        
        // Show success
        showAlert('¡Cuenta creada exitosamente! Redirigiendo al login...', 'success');
        
        // Redirect to login after 2 seconds
        setTimeout(() => {
            window.location.href = '/evaluaciones/login.html?username=' + encodeURIComponent(username);
        }, 2000);
        
    } catch (error) {
        console.error('Error creating account:', error);
        showAlert('Error al crear la cuenta. Por favor intenta nuevamente.', 'error');
        createBtn.disabled = false;
        createBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Crear Mi Cuenta';
    }
});

function showAlert(message, type) {
    const alert = document.getElementById('alert');
    const alertMessage = document.getElementById('alertMessage');
    
    alertMessage.textContent = message;
    alert.className = 'alert alert-' + type;
    alert.style.display = 'block';
    
    // Auto-hide after 5 seconds for errors
    if (type === 'error') {
        setTimeout(() => {
            alert.style.display = 'none';
        }, 5000);
    }
}
</script>

</body>
</html>
