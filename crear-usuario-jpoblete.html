<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Usuario jpoblete - Test</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <h1>Creando usuario jpoblete...</h1>
    <div id="status"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCzN4xNEE_hKshXbsVqLhWSnzet1pHwRh8",
            authDomain: "profe-blog.firebaseapp.com",
            databaseURL: "https://profe-blog-default-rtdb.firebaseio.com",
            projectId: "profe-blog",
            storageBucket: "profe-blog.firebasestorage.app",
            messagingSenderId: "305920739217",
            appId: "1:305920739217:web:2e08c7469d2988d8b3bc30"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        async function crearUsuario() {
            const statusDiv = document.getElementById('status');
            
            try {
                statusDiv.innerHTML += '<p>Verificando si el usuario ya existe...</p>';
                
                // Check if username already exists
                const usersRef = database.ref('users');
                const snapshot = await usersRef.orderByChild('username').equalTo('jpoblete').once('value');
                
                if (snapshot.exists()) {
                    statusDiv.innerHTML += '<p style="color: orange;">⚠️ El usuario "jpoblete" ya existe. Actualizando contraseña...</p>';
                    
                    // Update existing user's password
                    const userId = Object.keys(snapshot.val())[0];
                    const passwordBase64 = btoa('Francisco11');
                    
                    await database.ref('users/' + userId).update({
                        password: passwordBase64,
                        updatedAt: new Date().toISOString()
                    });
                    
                    statusDiv.innerHTML += '<p style="color: green;">✅ Contraseña actualizada exitosamente</p>';
                    statusDiv.innerHTML += `<p><strong>Usuario:</strong> jpoblete</p>`;
                    statusDiv.innerHTML += `<p><strong>Contraseña:</strong> Francisco11</p>`;
                    statusDiv.innerHTML += `<p><a href="/evaluaciones/login.html" style="color: blue;">Ir al login</a></p>`;
                    return;
                }
                
                statusDiv.innerHTML += '<p>Creando nuevo usuario...</p>';
                
                // Create new user
                const newUserRef = usersRef.push();
                const passwordBase64 = btoa('Francisco11'); // Base64 encoding
                
                const userData = {
                    username: 'jpoblete',
                    email: 'jpoblete@example.com',
                    name: 'Juan Poblete',
                    password: passwordBase64,
                    role: 'cliente',
                    permissions: { 
                        basica: true, 
                        media: true, 
                        parvularia: true 
                    },
                    active: true,
                    createdAt: new Date().toISOString(),
                    sourcePaymentId: 'TEST_MANUAL_' + Date.now(),
                    plan: 'Acceso Completo ECEP 2025'
                };
                
                await newUserRef.set(userData);
                
                statusDiv.innerHTML += '<p style="color: green;">✅ Usuario creado exitosamente</p>';
                statusDiv.innerHTML += `<p><strong>Usuario:</strong> jpoblete</p>`;
                statusDiv.innerHTML += `<p><strong>Contraseña:</strong> Francisco11</p>`;
                statusDiv.innerHTML += `<p><strong>Email:</strong> jpoblete@example.com</p>`;
                statusDiv.innerHTML += `<p><strong>ID Firebase:</strong> ${newUserRef.key}</p>`;
                statusDiv.innerHTML += `<p><a href="/evaluaciones/login.html?username=jpoblete" style="color: blue; font-weight: bold;">Ir al login →</a></p>`;
                
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML += `<p style="color: red;">❌ Error: ${error.message}</p>`;
            }
        }

        // Run automatically on load
        crearUsuario();
    </script>
</body>
</html>
