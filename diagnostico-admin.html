<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Firebase Admin</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .result { margin-top: 10px; padding: 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico del Sistema de Admin</h1>

    <div class="section info">
        <h3>Estado de Firebase</h3>
        <button onclick="checkFirebaseConfig()">Verificar Configuraci√≥n Firebase</button>
        <button onclick="checkAuthStatus()">Verificar Estado de Auth</button>
        <div id="firebase-status" class="result"></div>
    </div>

    <div class="section warning">
        <h3>Cuenta de Administrador</h3>
        <button onclick="checkAdminAccount()">Verificar si existe cuenta admin</button>
        <button onclick="createAdminAccount()">Crear cuenta admin</button>
        <button onclick="resetAdminPassword()">Resetear contrase√±a admin</button>
        <div id="admin-status" class="result"></div>
    </div>

    <div class="section success">
        <h3>Prueba de Login</h3>
        <input type="password" id="testPassword" placeholder="Contrase√±a a probar" value="AdminEval2025!">
        <button onclick="testAdminLogin()">Probar Login</button>
        <div id="login-status" class="result"></div>
    </div>

    <div class="section">
        <h3>Resultados del Diagn√≥stico</h3>
        <div id="diagnostics" class="result info">
            <p>Haz clic en los botones para diagnosticar el sistema...</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCzN4xNEE_hKshXbsVqLhWSnzet1pHwRh8",
            authDomain: "profe-blog.firebaseapp.com",
            databaseURL: "https://profe-blog-default-rtdb.firebaseio.com",
            projectId: "profe-blog",
            storageBucket: "profe-blog.firebasestorage.app",
            messagingSenderId: "305920739217",
            appId: "1:305920739217:web:2e08c7469d2988d8b3bc30"
        };

        let auth = null;
        let app = null;

        function updateDiagnostics(message, type = 'info') {
            const diagnostics = document.getElementById('diagnostics');
            diagnostics.className = `result ${type}`;
            diagnostics.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${message}</p>`;
        }

        async function checkFirebaseConfig() {
            const statusDiv = document.getElementById('firebase-status');
            statusDiv.className = 'result info';
            statusDiv.textContent = 'Verificando configuraci√≥n de Firebase...';

            try {
                if (!app) {
                    app = firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                }

                statusDiv.className = 'result success';
                statusDiv.innerHTML = `
                    <h4>‚úÖ Firebase configurado correctamente</h4>
                    <p><strong>Proyecto:</strong> ${firebaseConfig.projectId}</p>
                    <p><strong>Auth Domain:</strong> ${firebaseConfig.authDomain}</p>
                    <p><strong>Database URL:</strong> ${firebaseConfig.databaseURL}</p>
                `;

                updateDiagnostics('Configuraci√≥n de Firebase verificada correctamente', 'success');

            } catch (error) {
                statusDiv.className = 'result error';
                statusDiv.innerHTML = `
                    <h4>‚ùå Error en configuraci√≥n de Firebase</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
                updateDiagnostics(`Error en configuraci√≥n de Firebase: ${error.message}`, 'error');
            }
        }

        async function checkAuthStatus() {
            const statusDiv = document.getElementById('firebase-status');

            if (!auth) {
                await checkFirebaseConfig();
            }

            statusDiv.innerHTML += '<br><br>Verificando estado de Authentication...';

            try {
                // Check current user
                const currentUser = auth.currentUser;
                if (currentUser) {
                    statusDiv.innerHTML += `
                        <br><strong>Usuario actual:</strong> ${currentUser.email} (${currentUser.uid})
                    `;
                } else {
                    statusDiv.innerHTML += '<br><strong>Usuario actual:</strong> Ninguno (no autenticado)';
                }

                updateDiagnostics('Estado de Authentication verificado', 'success');

            } catch (error) {
                statusDiv.innerHTML += `<br><strong>Error:</strong> ${error.message}`;
                updateDiagnostics(`Error verificando Auth: ${error.message}`, 'error');
            }
        }

        async function checkAdminAccount() {
            const statusDiv = document.getElementById('admin-status');
            statusDiv.className = 'result info';
            statusDiv.textContent = 'Verificando existencia de cuenta admin...';

            if (!auth) {
                await checkFirebaseConfig();
            }

            try {
                // Try to sign in with a known password to check if account exists
                const testPasswords = ['AdminEval2025!', 'admin123', 'password', '123456'];

                for (const password of testPasswords) {
                    try {
                        const userCredential = await auth.signInWithEmailAndPassword('fconuva@gmail.com', password);
                        await auth.signOut();

                        statusDiv.className = 'result success';
                        statusDiv.innerHTML = `
                            <h4>‚úÖ Cuenta de admin encontrada</h4>
                            <p><strong>Email:</strong> fconuva@gmail.com</p>
                            <p><strong>Contrase√±a actual:</strong> ${password}</p>
                            <p><strong>UID:</strong> ${userCredential.user.uid}</p>
                        `;

                        updateDiagnostics(`Cuenta admin encontrada con contrase√±a: ${password}`, 'success');
                        return;

                    } catch (loginError) {
                        if (loginError.code !== 'auth/wrong-password') {
                            throw loginError;
                        }
                        // Continue trying other passwords
                    }
                }

                statusDiv.className = 'result warning';
                statusDiv.innerHTML = `
                    <h4>‚ö†Ô∏è Cuenta no encontrada o contrase√±a desconocida</h4>
                    <p>No se pudo verificar la cuenta con las contrase√±as comunes probadas.</p>
                    <p>Posibles causas:</p>
                    <ul>
                        <li>La cuenta no existe</li>
                        <li>La contrase√±a es diferente</li>
                        <li>Firebase Auth no est√° habilitado</li>
                    </ul>
                `;

                updateDiagnostics('Cuenta admin no encontrada con contrase√±as comunes', 'warning');

            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    statusDiv.className = 'result error';
                    statusDiv.innerHTML = `
                        <h4>‚ùå Cuenta de admin no existe</h4>
                        <p>La cuenta fconuva@gmail.com no est√° registrada en Firebase Auth.</p>
                        <p>Debes crear la cuenta primero.</p>
                    `;
                    updateDiagnostics('Cuenta admin no existe', 'error');
                } else {
                    statusDiv.className = 'result error';
                    statusDiv.innerHTML = `
                        <h4>‚ùå Error verificando cuenta</h4>
                        <p><strong>Error:</strong> ${error.code} - ${error.message}</p>
                    `;
                    updateDiagnostics(`Error verificando cuenta: ${error.message}`, 'error');
                }
            }
        }

        async function createAdminAccount() {
            const statusDiv = document.getElementById('admin-status');
            statusDiv.className = 'result info';
            statusDiv.textContent = 'Creando cuenta de administrador...';

            if (!auth) {
                await checkFirebaseConfig();
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword('fconuva@gmail.com', 'AdminEval2025!');

                statusDiv.className = 'result success';
                statusDiv.innerHTML = `
                    <h4>‚úÖ Cuenta de admin creada exitosamente</h4>
                    <p><strong>Email:</strong> fconuva@gmail.com</p>
                    <p><strong>Contrase√±a:</strong> AdminEval2025!</p>
                    <p><strong>UID:</strong> ${userCredential.user.uid}</p>
                    <p><em>Recuerda cambiar la contrase√±a despu√©s del primer login.</em></p>
                `;

                updateDiagnostics('Cuenta admin creada exitosamente', 'success');

                // Sign out immediately
                setTimeout(() => auth.signOut(), 1000);

            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    statusDiv.className = 'result warning';
                    statusDiv.innerHTML = `
                        <h4>‚ö†Ô∏è La cuenta ya existe</h4>
                        <p>La cuenta fconuva@gmail.com ya est√° registrada.</p>
                        <p>Si no recuerdas la contrase√±a, usa la funci√≥n de reset.</p>
                    `;
                    updateDiagnostics('Cuenta admin ya existe', 'warning');
                } else {
                    statusDiv.className = 'result error';
                    statusDiv.innerHTML = `
                        <h4>‚ùå Error creando cuenta</h4>
                        <p><strong>Error:</strong> ${error.code} - ${error.message}</p>
                    `;
                    updateDiagnostics(`Error creando cuenta: ${error.message}`, 'error');
                }
            }
        }

        async function resetAdminPassword() {
            const statusDiv = document.getElementById('admin-status');
            statusDiv.className = 'result info';
            statusDiv.textContent = 'Enviando email de reset de contrase√±a...';

            if (!auth) {
                await checkFirebaseConfig();
            }

            try {
                await auth.sendPasswordResetEmail('fconuva@gmail.com');

                statusDiv.className = 'result success';
                statusDiv.innerHTML = `
                    <h4>‚úÖ Email de reset enviado</h4>
                    <p>Se ha enviado un email a fconuva@gmail.com con instrucciones para resetear la contrase√±a.</p>
                    <p>Revisa tu bandeja de entrada (y spam).</p>
                `;

                updateDiagnostics('Email de reset enviado', 'success');

            } catch (error) {
                statusDiv.className = 'result error';
                statusDiv.innerHTML = `
                    <h4>‚ùå Error enviando email de reset</h4>
                    <p><strong>Error:</strong> ${error.code} - ${error.message}</p>
                `;
                updateDiagnostics(`Error enviando reset: ${error.message}`, 'error');
            }
        }

        async function testAdminLogin() {
            const password = document.getElementById('testPassword').value;
            const statusDiv = document.getElementById('login-status');
            statusDiv.className = 'result info';
            statusDiv.textContent = 'Probando login...';

            if (!auth) {
                await checkFirebaseConfig();
            }

            try {
                const userCredential = await auth.signInWithEmailAndPassword('fconuva@gmail.com', password);

                statusDiv.className = 'result success';
                statusDiv.innerHTML = `
                    <h4>‚úÖ Login exitoso</h4>
                    <p><strong>Email:</strong> ${userCredential.user.email}</p>
                    <p><strong>Contrase√±a usada:</strong> ${password}</p>
                    <p><strong>UID:</strong> ${userCredential.user.uid}</p>
                    <p><strong>Email verificado:</strong> ${userCredential.user.emailVerified}</p>
                `;

                updateDiagnostics(`Login exitoso con contrase√±a: ${password}`, 'success');

                // Sign out immediately
                setTimeout(() => auth.signOut(), 1000);

            } catch (error) {
                statusDiv.className = 'result error';
                statusDiv.innerHTML = `
                    <h4>‚ùå Error en login</h4>
                    <p><strong>Contrase√±a probada:</strong> ${password}</p>
                    <p><strong>Error:</strong> ${error.code} - ${error.message}</p>
                `;

                updateDiagnostics(`Login fallido: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateDiagnostics('P√°gina cargada. Haz clic en los botones para diagnosticar.', 'info');
        });
    </script>
</body>
</html>