---
layout: layout-evaluaciones.njk
title: "Pr√°ctica Interactiva: Matem√°tica ECEP 2025"
description: "Responde las 50 preguntas de la prueba 66-sc-m y prep√°rate con retroalimentaci√≥n IA personalizada."
---

<div class="min-h-screen bg-gradient-to-br from-orange-50 via-white to-red-50">
  <div class="container mx-auto px-4 py-12">
    <div class="max-w-5xl mx-auto">

      <!-- Encabezado Mejorado -->
      <div class="text-center mb-12">
        <div class="inline-block bg-orange-100 text-orange-800 text-sm font-semibold px-4 py-2 rounded-full mb-4">
          üî¢ Matem√°tica ECEP 2025
        </div>
        <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 mb-4 tracking-tight">
          Pr√°ctica Interactiva
        </h1>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto mb-6">
          50 preguntas + 10 casos de estudio con retroalimentaci√≥n pedag√≥gica inteligente
        </p>
        <div class="flex flex-wrap justify-center gap-4 text-sm text-gray-600">
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
            </svg>
            <span>60-90 minutos</span>
          </div>
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
              <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
            </svg>
            <span>70 preguntas</span>
          </div>
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
              <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
            </svg>
            <span>Retroalimentaci√≥n IA</span>
          </div>
        </div>
        <a href="/evaluaciones/educacion-basica/estudio/matematica/" class="mt-6 inline-flex items-center text-orange-600 hover:text-orange-800 font-medium transition-colors">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
          </svg>
          Volver a Gu√≠a de Matem√°tica
        </a>
      </div>

      <!-- Instrucciones -->
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 p-6 rounded-lg mb-8 shadow-sm">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="ml-4">
            <h3 class="text-lg font-bold text-blue-900 mb-2">üìñ Instrucciones</h3>
            <ul class="text-sm text-blue-800 space-y-2">
              <li>‚úì Responde las 50 preguntas regulares + 10 casos de estudio (70 total)</li>
              <li>‚úì Revisa tus respuestas para recibir correcci√≥n inmediata</li>
              <li>‚úì Usa el bot√≥n <strong>"Consultar IA"</strong> para obtener explicaciones detalladas</li>
              <li>‚úì La IA explica por qu√© una alternativa es correcta y las dem√°s son incorrectas</li>
              <li>‚úì Puedes consultar la IA en cualquier pregunta, incluso si acertaste</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Barra de progreso -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-8">
        <div class="flex justify-between items-center mb-3">
          <span class="text-sm font-semibold text-gray-700">Progreso</span>
          <span class="text-sm font-bold text-orange-600" id="progress-text">0/70 respondidas</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
          <div id="progress-bar" class="bg-gradient-to-r from-orange-500 to-red-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>

      <!-- Contenedor del Quiz -->
      <div id="quiz-container" class="space-y-6">
        <form id="quiz-form">
          <!-- PREGUNTAS REGULARES (1-50) -->
          {% for pregunta in plan.exam.preguntas %}
            <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 p-6 md:p-8 border-l-4 border-orange-400" id="pregunta-{{ loop.index }}">
              
              <!-- N√∫mero y tema -->
              <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3">
                  <span class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-orange-500 to-red-500 text-white font-bold rounded-full flex items-center justify-center text-lg shadow-md">
                    {{ loop.index }}
                  </span>
                  <div>
                    <span class="inline-block bg-orange-100 text-orange-800 text-xs font-semibold px-3 py-1 rounded-full">
                      {{ pregunta.temas_relacionados[0] or 'Matem√°tica' }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Enunciado -->
              <p class="text-lg font-semibold text-gray-900 mb-6 leading-relaxed">
                {{ pregunta.enunciado | safe }}
              </p>

              <!-- Alternativas -->
              <div class="space-y-3 mb-6">
                {% for alternativa in pregunta.alternativas %}
                  <label class="flex items-start p-4 border-2 border-gray-200 rounded-xl hover:border-orange-400 hover:bg-orange-50 cursor-pointer transition-all duration-200 group">
                    <input 
                      type="radio" 
                      name="pregunta-{{ loop.parent.loop.index }}" 
                      value="{{ alternativa.opcion }}" 
                      class="mt-1 h-5 w-5 text-orange-600 focus:ring-orange-500 border-gray-300 cursor-pointer"
                      data-question="{{ loop.parent.loop.index }}"
                    >
                    <span class="ml-4 text-gray-800 group-hover:text-gray-900 font-medium">
                      <strong class="text-orange-600">{{ alternativa.opcion }})</strong> {{ alternativa.texto }}
                    </span>
                  </label>
                {% endfor %}
              </div>

              <!-- Feedback zona -->
              <div id="feedback-{{ loop.index }}" class="hidden"></div>

              <!-- Bot√≥n IA (siempre visible despu√©s de responder) -->
              <div id="ia-actions-{{ loop.index }}" class="mt-4 hidden">
                <button 
                  type="button" 
                  data-q="{{ loop.index }}" 
                  class="ia-btn inline-flex items-center gap-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white text-sm font-semibold py-3 px-5 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105"
                >
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
                  </svg>
                  Consultar IA - Ver Explicaci√≥n Completa
                </button>
              </div>

              <!-- Feedback IA -->
              <div id="ia-feedback-{{ loop.index }}" class="mt-4 hidden"></div>

            </div>
          {% endfor %}
          

          <!-- CASOS DE ESTUDIO (51+) -->
          {% if plan.casos_estudio %}
            <div class="mt-12 mb-8 bg-gradient-to-r from-amber-100 to-yellow-100 border-2 border-amber-400 rounded-2xl p-8">
              <div class="text-center">
                <h2 class="text-3xl font-bold text-amber-900 mb-3">üìö Casos de Estudio Matem√°ticos</h2>
                <p class="text-amber-800 text-lg">
                  Situaciones pedag√≥gicas reales para evaluar tu comprensi√≥n contextualizada
                </p>
              </div>
            </div>

            {% for caso in plan.casos_estudio %}
              {% set casoNum = loop.index + 50 %}
              
              <!-- Contexto del caso -->
              <div class="bg-gradient-to-br from-amber-50 to-yellow-50 border-l-4 border-amber-500 rounded-xl p-8 shadow-lg mb-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="bg-amber-500 text-white font-bold px-4 py-2 rounded-full text-sm">
                    CASO {{ loop.index }}
                  </span>
                  <h3 class="text-xl font-bold text-amber-900">Situaci√≥n Pedag√≥gica</h3>
                </div>
                <div class="bg-white rounded-lg p-6 text-gray-800 leading-relaxed border border-amber-200">
                  {{ caso.contexto | safe }}
                </div>
              </div>

              <!-- Pregunta √∫nica del caso -->
              <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 p-6 md:p-8 border-l-4 border-amber-400 mb-8" id="pregunta-{{ casoNum }}">
                <div class="flex items-start justify-between mb-4">
                  <div class="flex items-center gap-3">
                    <span class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-amber-500 to-yellow-600 text-white font-bold rounded-full flex items-center justify-center text-lg shadow-md">
                      {{ casoNum }}
                    </span>
                    <span class="inline-block bg-amber-100 text-amber-800 text-xs font-semibold px-3 py-1 rounded-full">
                      Caso de Estudio
                    </span>
                  </div>
                </div>

                <p class="text-lg font-semibold text-gray-900 mb-6 leading-relaxed">
                  {{ caso.enunciado | safe }}
                </p>

                <div class="space-y-3 mb-6">
                  {% for alt in caso.alternativas %}
                    <label class="flex items-start p-4 border-2 border-gray-200 rounded-xl hover:border-amber-400 hover:bg-amber-50 cursor-pointer transition-all duration-200 group">
                      <input 
                        type="radio" 
                        name="pregunta-{{ casoNum }}" 
                        value="{{ alt.opcion }}" 
                        class="mt-1 h-5 w-5 text-amber-600 focus:ring-amber-500 border-gray-300 cursor-pointer"
                        data-question="{{ casoNum }}"
                      >
                      <span class="ml-4 text-gray-800 group-hover:text-gray-900 font-medium">
                        <strong class="text-amber-600">{{ alt.opcion }})</strong> {{ alt.texto }}
                      </span>
                    </label>
                  {% endfor %}
                </div>

                <div id="feedback-{{ casoNum }}" class="hidden"></div>
                <div id="ia-actions-{{ casoNum }}" class="mt-4 hidden">
                  <button 
                    type="button" 
                    data-q="{{ casoNum }}" 
                    class="ia-btn inline-flex items-center gap-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white text-sm font-semibold py-3 px-5 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105"
                  >
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
                    </svg>
                    Consultar IA - Ver Explicaci√≥n Completa
                  </button>
                </div>
                <div id="ia-feedback-{{ casoNum }}" class="mt-4 hidden"></div>
              </div>
            {% endfor %}
          {% endif %}
          
          <!-- Bot√≥n revisar -->
          <div class="mt-10 text-center">
            <button 
              type="submit" 
              class="bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white font-bold py-4 px-12 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 text-lg"
            >
              ‚úÖ Revisar mis respuestas
            </button>
          </div>
        </form>

        <!-- Resultado final -->
        <div id="resultado-final" class="hidden mt-10">
          <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-400 rounded-2xl shadow-xl p-8 text-center">
            <div class="mb-6">
              <svg class="w-20 h-20 mx-auto text-green-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            </div>
            <h2 class="text-4xl font-extrabold text-gray-900 mb-4">Resultados</h2>
            <p class="text-2xl text-gray-700 mb-2">
              Has respondido correctamente
            </p>
            <p class="text-5xl font-bold text-green-600 mb-6">
              <span id="puntaje"></span>/70
            </p>
            <div class="bg-white rounded-lg p-4 inline-block">
              <p class="text-lg text-gray-600">
                Porcentaje: <span id="porcentaje" class="font-bold text-gray-900"></span>%
              </p>
            </div>
            <div class="mt-8 pt-6 border-t border-green-300">
              <p class="text-sm text-gray-600 mb-4">
                üí° Usa los botones <strong>"Consultar IA"</strong> para profundizar en las preguntas que fallaste
              </p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const plan = {{ plan | dump | safe }};
  const quizForm = document.getElementById('quiz-form');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  const totalPreguntasRegulares = plan.exam.preguntas.length;
  const totalCasos = plan.casos_estudio ? plan.casos_estudio.length * 2 : 0;
  const totalPreguntas = totalPreguntasRegulares + totalCasos;

  // Actualizar progreso en tiempo real
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', () => {
      const respondidas = new Set();
      document.querySelectorAll('input[type="radio"]:checked').forEach(r => {
        respondidas.add(r.getAttribute('data-question'));
      });
      const count = respondidas.size;
      const percentage = Math.round((count / totalPreguntas) * 100);
      progressBar.style.width = `${percentage}%`;
      progressText.textContent = `${count}/${totalPreguntas} respondidas`;
    });
  });

  // Revisi√≥n del formulario
  quizForm.addEventListener('submit', function(event) {
    event.preventDefault();
    
    let puntaje = 0;

    // Funci√≥n helper para procesar feedback
    function procesarRespuesta(preguntaIndex, respuestaCorrecta, explicacion) {
      const feedbackEl = document.getElementById(`feedback-${preguntaIndex}`);
      const iaActionsEl = document.getElementById(`ia-actions-${preguntaIndex}`);
      const selectedOption = document.querySelector(`input[name="pregunta-${preguntaIndex}"]:checked`);
      
      if (!feedbackEl || !iaActionsEl) return 0;
      
      feedbackEl.classList.remove('hidden');
      iaActionsEl.classList.remove('hidden');
      
      if (selectedOption) {
        const esCorrecta = selectedOption.value === respuestaCorrecta;
        if (esCorrecta) {
          feedbackEl.innerHTML = `
            <div class="bg-gradient-to-r from-green-100 to-emerald-100 border-l-4 border-green-500 p-5 rounded-lg shadow-sm">
              <div class="flex items-start">
                <svg class="w-6 h-6 text-green-600 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <div>
                  <p class="font-bold text-green-900 text-lg mb-2">¬°Correcto! ‚úÖ</p>
                  <p class="text-green-800 leading-relaxed">${explicacion}</p>
                </div>
              </div>
            </div>
          `;
          return 1;
        } else {
          feedbackEl.innerHTML = `
            <div class="bg-gradient-to-r from-red-100 to-pink-100 border-l-4 border-red-500 p-5 rounded-lg shadow-sm">
              <div class="flex items-start">
                <svg class="w-6 h-6 text-red-600 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <div>
                  <p class="font-bold text-red-900 text-lg mb-2">Incorrecto ‚ùå</p>
                  <p class="text-red-800 mb-2">
                    Tu respuesta: <strong class="bg-red-200 px-2 py-1 rounded">${selectedOption.value}</strong>
                  </p>
                  <p class="text-red-800 mb-3">
                    Respuesta correcta: <strong class="bg-green-200 px-2 py-1 rounded">${respuestaCorrecta}</strong>
                  </p>
                  <p class="text-red-900 leading-relaxed font-medium">${explicacion}</p>
                </div>
              </div>
            </div>
          `;
          return 0;
        }
      } else {
        feedbackEl.innerHTML = `
          <div class="bg-gradient-to-r from-yellow-100 to-amber-100 border-l-4 border-yellow-500 p-5 rounded-lg shadow-sm">
            <div class="flex items-start">
              <svg class="w-6 h-6 text-yellow-600 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              <div>
                <p class="font-bold text-yellow-900 text-lg mb-2">No respondida ‚ö†Ô∏è</p>
                <p class="text-yellow-800">
                  Respuesta correcta: <strong class="bg-green-200 px-2 py-1 rounded">${respuestaCorrecta}</strong>
                </p>
              </div>
            </div>
          </div>
        `;
        return 0;
      }
    }

    // Procesar preguntas regulares (1-50)
    plan.exam.preguntas.forEach((pregunta, index) => {
      const preguntaIndex = index + 1;
      puntaje += procesarRespuesta(preguntaIndex, pregunta.respuesta_correcta, pregunta.explicacion);
    });

    // Procesar casos de estudio (51+)
    if (plan.casos_estudio) {
      plan.casos_estudio.forEach((caso, casoIndex) => {
        const baseNum = 51 + casoIndex;
        
        // Pregunta del caso (cada caso tiene 1 pregunta en matem√°tica)
        puntaje += procesarRespuesta(
          baseNum, 
          caso.respuesta_correcta, 
          caso.explicacion
        );
      });
    }

    // Mostrar resultado final
    const resultadoFinalEl = document.getElementById('resultado-final');
    const porcentaje = Math.round((puntaje / totalPreguntas) * 100);
    document.getElementById('puntaje').textContent = puntaje;
    document.getElementById('porcentaje').textContent = porcentaje;
    resultadoFinalEl.classList.remove('hidden');
    
    // Scroll suave al resultado
    resultadoFinalEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });

  // Delegaci√≥n de eventos para botones IA
  document.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('.ia-btn');
    if (!btn) return;
    
    // Prevenir m√∫ltiples clics
    if (btn.disabled) return;
    btn.disabled = true;
    
    const qIndex = Number(btn.getAttribute('data-q'));
    const pregunta = plan.exam.preguntas[qIndex - 1];
    const selected = document.querySelector(`input[name="pregunta-${qIndex}"]:checked`);
    const iaBox = document.getElementById(`ia-feedback-${qIndex}`);
    
    iaBox.classList.remove('hidden');
    iaBox.innerHTML = `
      <div class="bg-gradient-to-r from-blue-100 to-indigo-100 border-l-4 border-blue-500 p-6 rounded-lg shadow-md animate-pulse">
        <div class="flex items-center">
          <svg class="animate-spin h-6 w-6 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p class="text-blue-900 font-semibold">ü§ñ Generando explicaci√≥n pedag√≥gica con IA...</p>
        </div>
      </div>
    `;

    // Construir contexto completo de la pregunta
    const tema = (pregunta.temas_relacionados && pregunta.temas_relacionados[0]) || 'Matem√°tica';
    const respuestaCorrecta = pregunta.respuesta_correcta;
    const alternativas = pregunta.alternativas.map(alt => `${alt.opcion}) ${alt.texto}`).join('\n');
    
    const preguntaCompleta = `PREGUNTA ${qIndex}: ${pregunta.enunciado}

ALTERNATIVAS:
${alternativas}

RESPUESTA CORRECTA: ${respuestaCorrecta}

EXPLICACI√ìN OFICIAL: ${pregunta.explicacion}`;

    try {
      const resp = await fetch('/api/groq-feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          pregunta: preguntaCompleta, 
          respuestaDocente: selected ? selected.value : 'No respondida', 
          tema,
          tipo: 'explicacion_completa_matematica',
          metadata: {
            codigo_prueba: plan.metadata.codigo_prueba,
            nombre_prueba: plan.metadata.nombre
          }
        })
      });
      
      const data = await resp.json();
      
      if (!resp.ok) throw new Error(data.error || 'Error al conectar con la IA');
      
      const text = data.feedback || 'No se recibi√≥ retroalimentaci√≥n.';
      
      // Renderizar markdown mejorado
      let html = text
        .replace(/\n\n/g, '</p><p class="mt-4">')
        .replace(/### (.+)/g, '<h4 class="text-lg font-bold text-indigo-800 mt-6 mb-3 border-b border-indigo-200 pb-2">$1</h4>')
        .replace(/## (.+)/g, '<h3 class="text-xl font-bold text-indigo-900 mt-7 mb-4 border-b-2 border-indigo-300 pb-2">$1</h3>')
        .replace(/\*\*(.+?)\*\*/g, '<strong class="text-gray-900 font-bold">$1</strong>')
        .replace(/\*(.+?)\*/g, '<em class="text-gray-800">$1</em>')
        .replace(/^- (.+)$/gm, '<li class="ml-6 mb-2 text-gray-800">$1</li>')
        .replace(/^(\d+)\. (.+)$/gm, '<li class="ml-6 mb-2 text-gray-800"><strong class="text-indigo-600">$1.</strong> $2</li>')
        .replace(/> (.+)/g, '<blockquote class="border-l-4 border-indigo-400 pl-4 py-3 my-4 italic text-gray-700 bg-indigo-50 rounded">$1</blockquote>')
        .replace(/`(.+?)`/g, '<code class="bg-gray-200 text-gray-900 px-2 py-1 rounded text-sm font-mono">$1</code>');
      
      iaBox.innerHTML = `
        <div class="bg-gradient-to-br from-white to-indigo-50 border-2 border-indigo-300 rounded-xl shadow-lg overflow-hidden">
          <div class="bg-gradient-to-r from-indigo-600 to-blue-600 px-6 py-4">
            <div class="flex items-center justify-between">
              <h4 class="font-bold text-white text-lg flex items-center gap-2">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
                </svg>
                Explicaci√≥n IA Pedag√≥gica
              </h4>
              <span class="bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full">
                ‚úì Correcta: ${respuestaCorrecta}
              </span>
            </div>
          </div>
          <div class="px-6 py-6">
            <div class="prose prose-indigo max-w-none text-gray-800 leading-relaxed">
              <p class="mt-0">${html}</p>
            </div>
          </div>
        </div>
      `;
    } catch (e) {
      iaBox.innerHTML = `
        <div class="bg-gradient-to-r from-red-100 to-pink-100 border-l-4 border-red-500 p-5 rounded-lg shadow-md">
          <div class="flex items-start">
            <svg class="w-6 h-6 text-red-600 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <div>
              <p class="font-bold text-red-900 text-lg mb-2">Error al consultar IA</p>
              <p class="text-red-800 text-sm">${e.message || 'No se pudo conectar con el servicio de IA. Intenta nuevamente.'}</p>
            </div>
          </div>
        </div>
      `;
    } finally {
      btn.disabled = false;
    }
  });
</script>
