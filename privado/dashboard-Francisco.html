<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4F46E5">
    <title>Dashboard Privado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #f0f2f5;
            -webkit-overflow-scrolling: touch;
        }
        
        * {
            -webkit-tap-highlight-color: rgba(79, 70, 229, 0.2);
        }
        
        button, a {
            -webkit-tap-highlight-color: rgba(79, 70, 229, 0.3);
        }
        
        .tool-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Optimizaciones móvil */
        @media (max-width: 768px) {
            main {
                padding: 1rem !important;
            }
            
            h1 {
                font-size: 1.5rem !important;
            }
            
            .tool-card {
                padding: 1rem !important;
            }
            
            button {
                min-height: 44px;
                min-width: 44px;
            }
            
            .grid {
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
            }
        }
        
        @media (min-width: 768px) and (max-width: 1024px) {
            .grid {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
        }
        
        /* iOS safe area */
        @supports (-webkit-touch-callout: none) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Auth Guard -->
    <script>
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'index.html';
        }
    </script>

    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                    <span class="text-2xl font-bold text-indigo-600">Dashboard</span>
                </div>
                <div class="flex items-center gap-4">
                    <span id="userWelcome" class="text-sm font-semibold text-gray-700"></span>
                    <button id="logout-btn" class="flex items-center text-sm text-gray-600 hover:text-indigo-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Espacio Privado</h1>
            <p class="mt-2 text-lg text-gray-600">Contenido en construcción.</p>
        </header>

        <section>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                
                <!-- Registro de Notas - Francisco -->
                <div class="tool-card bg-white rounded-xl shadow-lg overflow-hidden border-2 border-indigo-400">
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <div class="p-3 rounded-full bg-indigo-100 text-indigo-600">
                                <i class="fas fa-clipboard-list fa-lg"></i>
                            </div>
                            <div class="ml-4 flex-1">
                                <h3 class="text-xl font-semibold text-gray-800">Registro de Notas</h3>
                                <p class="text-sm text-indigo-600 font-medium">Prof. Francisco Conuva</p>
                            </div>
                        </div>
                        <p class="text-gray-600 mb-4">Sistema completo de gestión de notas con informes individuales y estadísticas del curso.</p>
                        <p class="text-xs text-gray-500 mb-3">
                            <i class="fas fa-graduation-cap mr-1"></i>
                            3° y 4° Medio - Lenguaje y Comunicación
                        </p>
                        <a href="registro-notas.html?docente=francisco" class="inline-block w-full text-center bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors">
                            Abrir Sistema
                        </a>
                    </div>
                </div>

                <!-- Registro de Notas - Otro Docente -->
                <div class="tool-card bg-white rounded-xl shadow-lg overflow-hidden border-2 border-purple-400">
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-clipboard-list fa-lg"></i>
                            </div>
                            <div class="ml-4 flex-1">
                                <h3 class="text-xl font-semibold text-gray-800">Registro de Notas</h3>
                                <p class="text-sm text-purple-600 font-medium" id="profesor2Name">Otro Docente</p>
                            </div>
                        </div>
                        <p class="text-gray-600 mb-4">Sistema completo de gestión de notas con informes individuales y estadísticas del curso.</p>
                        <p class="text-xs text-gray-500 mb-3" id="profesor2Info">
                            <i class="fas fa-graduation-cap mr-1"></i>
                            Espacio independiente para otro profesor
                        </p>
                        <div class="space-y-2">
                            <a href="registro-notas.html?docente=profesor2" class="inline-block w-full text-center bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-600 transition-colors">
                                Abrir Sistema
                            </a>
                            <a href="setup-profesor2.html" class="inline-block w-full text-center border-2 border-purple-500 text-purple-600 font-semibold py-2 px-4 rounded-lg hover:bg-purple-50 transition-colors text-sm">
                                <i class="fas fa-cog mr-1"></i>Configurar Perfil
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Importar Cursos -->
                <div class="tool-card bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-file-import fa-lg"></i>
                            </div>
                            <h3 class="ml-4 text-xl font-semibold text-gray-800">Importar Cursos</h3>
                        </div>
                        <p class="text-gray-600 mb-4">Importa múltiples cursos desde archivos CSV de forma automática y rápida.</p>
                        <a href="importar-cursos.html" class="inline-block w-full text-center bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                            Importar CSV
                        </a>
                    </div>
                </div>

                <!-- Limpiar Cursos - SOLO ADMIN -->
                <div id="adminSection" class="tool-card bg-white rounded-xl shadow-lg overflow-hidden border-2 border-red-400">
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <div class="p-3 rounded-full bg-red-100 text-red-600">
                                <i class="fas fa-trash-alt fa-lg"></i>
                            </div>
                            <h3 class="ml-4 text-xl font-semibold text-gray-800">Gestionar Cursos</h3>
                            <span class="ml-auto text-xs font-bold bg-red-100 text-red-700 px-2 py-1 rounded">ADMIN</span>
                        </div>
                        <p class="text-gray-600 mb-4">Visualiza y gestiona tus cursos en la base de datos.</p>
                        
                        <button onclick="verCursosActuales()" 
                                id="verCursosBtn"
                                class="inline-block w-full text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors shadow-lg mb-2">
                            <i class="fas fa-list mr-2"></i>VER CURSOS ACTUALES
                        </button>
                        
                        <button onclick="borrarTodoDefinitivo()" 
                                id="borrarBtn"
                                class="inline-block w-full text-center bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors shadow-lg">
                            <i class="fas fa-trash-alt mr-2"></i>BORRAR TODOS LOS CURSOS
                        </button>
                        <p class="text-xs text-red-600 font-semibold mt-2">⚠️ Esto eliminará TODOS los cursos del navegador y la base de datos. No se puede deshacer.</p>
                        
                        <div id="cursosListado" class="mt-4 hidden">
                            <div class="bg-gray-50 border border-gray-300 rounded-lg p-4 max-h-96 overflow-y-auto">
                                <h4 class="font-bold text-gray-800 mb-3">Cursos en la Base de Datos:</h4>
                                <div id="cursosContent"></div>
                            </div>
                        </div>
                        
                        <div id="migracionStatus" class="mt-4 hidden">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                                <p class="text-sm text-green-800 font-semibold">
                                    <i class="fas fa-check-circle mr-2"></i><span id="statusText">Preparando...</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </main>

    <script>
        // Sistema de Control de Permisos
        function initializePermissions() {
            const userRole = sessionStorage.getItem('userRole') || 'teacher';
            const userFullName = sessionStorage.getItem('userFullName') || 'Usuario';
            const username = sessionStorage.getItem('username') || '';
            
            // Mostrar bienvenida
            const welcomeEl = document.getElementById('userWelcome');
            if (welcomeEl) {
                welcomeEl.innerHTML = `<i class="fas fa-user-circle mr-1"></i> ${userFullName}`;
            }
            
            // Si NO es admin, ocultar sección de administración
            if (userRole !== 'admin') {
                const adminSection = document.getElementById('adminSection');
                if (adminSection) {
                    adminSection.style.display = 'none';
                }
                
                // Mostrar mensaje informativo en su lugar
                const container = adminSection ? adminSection.parentElement : null;
                if (container) {
                    const infoCard = document.createElement('div');
                    infoCard.className = 'bg-blue-50 border-2 border-blue-200 rounded-xl p-6 text-center';
                    infoCard.innerHTML = `
                        <div class="text-blue-600 mb-3">
                            <i class="fas fa-info-circle text-4xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-blue-900 mb-2">Cuenta de Profesora</h3>
                        <p class="text-sm text-blue-700">
                            Tienes permisos para registrar notas, generar informes y trabajar con cursos existentes.
                        </p>
                        <p class="text-xs text-blue-600 mt-2">
                            <i class="fas fa-lock mr-1"></i>
                            La gestión avanzada de cursos está reservada para el administrador.
                        </p>
                    `;
                    container.appendChild(infoCard);
                }
                
                console.log(`👤 Sesión iniciada como: ${userFullName} (Profesora - Permisos limitados)`);
            } else {
                console.log(`🔑 Sesión iniciada como: ${userFullName} (Administrador - Todos los permisos)`);
            }
        }
        
        // Inicializar permisos al cargar la página
        document.addEventListener('DOMContentLoaded', initializePermissions);
        
        document.getElementById('logout-btn').addEventListener('click', function() {
            sessionStorage.removeItem('isLoggedIn');
            sessionStorage.removeItem('username');
            sessionStorage.removeItem('userRole');
            sessionStorage.removeItem('userFullName');
            window.location.href = 'index.html';
        });

        // VER CURSOS ACTUALES EN LA BASE DE DATOS
        async function verCursosActuales() {
            const btn = document.getElementById('verCursosBtn');
            const listadoDiv = document.getElementById('cursosListado');
            const contentDiv = document.getElementById('cursosContent');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>CARGANDO...';
            
            try {
                const username = sessionStorage.getItem('username') || 'fconuva';
                const response = await fetch(`/api/courses?username=${encodeURIComponent(username)}`);
                const data = await response.json();
                
                if (data.success && data.courses) {
                    const courses = data.courses;
                    
                    if (courses.length === 0) {
                        contentDiv.innerHTML = '<p class="text-gray-600">No hay cursos en la base de datos.</p>';
                    } else {
                        let html = '<div class="space-y-2">';
                        courses.forEach((course, index) => {
                            html += `
                                <div class="bg-white border border-gray-200 rounded p-3 flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold text-gray-800">${index + 1}. ${course.courseName || 'Sin nombre'}</p>
                                        <p class="text-xs text-gray-600">
                                            ${course.students?.length || 0} estudiantes, 
                                            ${course.tasks?.length || 0} tareas
                                        </p>
                                        <p class="text-xs text-gray-500">ID: ${course.id}</p>
                                    </div>
                                    <button onclick="borrarCursoEspecifico(${course.id}, '${course.courseName}')" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        });
                        html += '</div>';
                        contentDiv.innerHTML = html;
                    }
                    
                    listadoDiv.classList.remove('hidden');
                } else {
                    contentDiv.innerHTML = '<p class="text-red-600">Error al cargar cursos.</p>';
                    listadoDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error:', error);
                contentDiv.innerHTML = '<p class="text-red-600">Error de conexión.</p>';
                listadoDiv.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-list mr-2"></i>VER CURSOS ACTUALES';
            }
        }

        // BORRAR UN CURSO ESPECÍFICO
        async function borrarCursoEspecifico(courseId, courseName) {
            if (!confirm(`¿Borrar el curso "${courseName}"?\n\nEsta acción no se puede deshacer.`)) {
                return;
            }
            
            console.log('🗑️ Intentando borrar curso:', { courseId, courseName });
            
            try {
                const username = sessionStorage.getItem('username') || 'fconuva';
                const response = await fetch('/api/courses/delete', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        courseId: courseId,
                        username: username
                    })
                });
                
                const responseData = await response.json();
                console.log('📤 Respuesta del servidor:', responseData);
                
                if (response.ok) {
                    alert('✅ Curso eliminado exitosamente');
                    verCursosActuales(); // Recargar lista
                } else {
                    console.error('❌ Error del servidor:', responseData);
                    alert(`❌ Error al eliminar el curso:\n${responseData.error || 'Error desconocido'}\n\nRevisa la consola para más detalles.`);
                }
            } catch (error) {
                console.error('❌ Error de conexión:', error);
                alert('❌ Error de conexión. Revisa la consola.');
            }
        }

        // BORRAR TODO DEFINITIVAMENTE
        async function borrarTodoDefinitivo() {
            const confirmar = confirm('⚠️⚠️⚠️ ADVERTENCIA CRÍTICA ⚠️⚠️⚠️\n\nEsto BORRARÁ PERMANENTEMENTE:\n• Todos los cursos del navegador\n• Todos los cursos de la base de datos\n• Todos los estudiantes y tareas\n\n❌ NO SE PUEDE DESHACER ❌\n\n¿Estás ABSOLUTAMENTE seguro?');
            
            if (!confirmar) {
                return;
            }

            const segundaConfirmacion = confirm('Segunda confirmación:\n\n¿De verdad quieres BORRAR TODO?\n\nEscribe OK mentalmente y presiona Aceptar para continuar.');
            
            if (!segundaConfirmacion) {
                return;
            }

            const btn = document.getElementById('borrarBtn');
            const statusDiv = document.getElementById('migracionStatus');
            const statusText = document.getElementById('statusText');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>BORRANDO...';
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            statusDiv.classList.remove('hidden');

            try {
                const username = sessionStorage.getItem('username') || 'fconuva';
                
                // Paso 1: Obtener todos los cursos actuales de la BD
                statusText.textContent = 'Paso 1/4: Obteniendo lista de cursos...';
                const getResponse = await fetch(`/api/courses?username=${encodeURIComponent(username)}`);
                const getData = await getResponse.json();
                
                let cursosABorrar = [];
                if (getData.success && getData.courses) {
                    cursosABorrar = getData.courses;
                    console.log('📋 Cursos a borrar:', cursosABorrar.length);
                }
                
                await new Promise(resolve => setTimeout(resolve, 300));

                // Paso 2: Borrar cada curso de la base de datos uno por uno
                statusText.textContent = `Paso 2/4: Eliminando ${cursosABorrar.length} cursos de la base de datos...`;
                
                for (let i = 0; i < cursosABorrar.length; i++) {
                    const curso = cursosABorrar[i];
                    console.log(`🗑️ Borrando curso ${i + 1}/${cursosABorrar.length}: ${curso.courseName} (ID: ${curso.id})`);
                    
                    try {
                        const deleteResponse = await fetch('/api/courses/delete', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                courseId: curso.id,
                                username: username
                            })
                        });
                        
                        if (deleteResponse.ok) {
                            console.log(`✅ Curso ${curso.courseName} eliminado`);
                        } else {
                            const errorData = await deleteResponse.json();
                            console.warn(`⚠️ No se pudo eliminar ${curso.courseName}:`, errorData);
                        }
                    } catch (e) {
                        console.error(`❌ Error eliminando ${curso.courseName}:`, e);
                    }
                    
                    statusText.textContent = `Paso 2/4: Eliminando ${i + 1}/${cursosABorrar.length} cursos...`;
                }
                
                await new Promise(resolve => setTimeout(resolve, 500));

                // Paso 3: Borrar localStorage COMPLETAMENTE
                statusText.textContent = 'Paso 3/4: Limpiando navegador...';
                localStorage.clear();
                await new Promise(resolve => setTimeout(resolve, 300));

                // Paso 4: Establecer bandera de "borrado total"
                statusText.textContent = 'Paso 4/4: Finalizando limpieza...';
                localStorage.setItem('totalWipeCompleted', Date.now().toString());
                localStorage.setItem('allCourses', '[]');
                localStorage.setItem('currentCourseId', '');
                await new Promise(resolve => setTimeout(resolve, 500));

                // ÉXITO
                statusText.innerHTML = '<i class="fas fa-check-circle mr-2"></i>✅ TODO ELIMINADO. Ahora puedes agregar cursos manualmente.';
                statusDiv.querySelector('div').classList.remove('bg-green-50', 'border-green-200');
                statusDiv.querySelector('div').classList.add('bg-blue-50', 'border-blue-400');
                statusDiv.querySelector('p').classList.remove('text-green-800');
                statusDiv.querySelector('p').classList.add('text-blue-900');

                btn.innerHTML = '<i class="fas fa-check mr-2"></i>BORRADO COMPLETADO';
                btn.classList.add('bg-gray-500');

                // Redirigir después de 3 segundos
                setTimeout(() => {
                    if (confirm('¿Quieres ir al Sistema de Registro de Notas para agregar cursos manualmente?')) {
                        window.location.href = 'registro-notas.html';
                    } else {
                        location.reload();
                    }
                }, 2000);

            } catch (error) {
                console.error('Error al borrar:', error);
                statusText.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error: ' + error.message;
                statusDiv.querySelector('div').classList.remove('bg-green-50', 'border-green-200');
                statusDiv.querySelector('div').classList.add('bg-red-50', 'border-red-200');
                statusDiv.querySelector('p').classList.remove('text-green-800');
                statusDiv.querySelector('p').classList.add('text-red-800');
                
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash-alt mr-2"></i>REINTENTAR BORRADO';
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // MIGRACIÓN AUTOMÁTICA COMPLETA (DEPRECADA - NO SE USA)
        async function iniciarMigracionCompleta_OLD() {
            const btn = document.getElementById('migracionBtn');
            const statusDiv = document.getElementById('migracionStatus');
            const statusText = document.getElementById('statusText');

            // Desactivar botón
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>PROCESANDO...';
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            statusDiv.classList.remove('hidden');

            try {
                // Paso 1: Preparar datos
                statusText.textContent = 'Paso 1/3: Preparando 8 cursos...';
                
                // Función auxiliar para crear curso con grades sincronizadas
                const crearCurso = (nombre, asignatura, numEstudiantes, numTareas) => {
                    const tareas = generarTareas(numTareas);
                    const estudiantes = generarEstudiantes(numEstudiantes);
                    
                    // Inicializar grades array con la longitud correcta (número de tareas)
                    estudiantes.forEach(estudiante => {
                        estudiante.grades = Array(numTareas).fill(null);
                    });
                    
                    return {
                        courseName: nombre,
                        subject: asignatura,
                        period: "2024",
                        students: estudiantes,
                        tasks: tareas
                    };
                };

                const cursosCompletos = [
                    crearCurso("3° Medio A", "Lenguaje y Comunicación", 35, 12),
                    crearCurso("3° Medio B", "Lenguaje y Comunicación", 32, 12),
                    crearCurso("4° Medio A", "Lenguaje y Comunicación", 28, 15),
                    crearCurso("4° Medio B", "Lenguaje y Comunicación", 30, 15),
                    crearCurso("3° Medio HC", "Humanista Científico", 38, 10),
                    crearCurso("3° Medio TP", "Técnico Profesional", 25, 10),
                    crearCurso("4° Medio HC", "Humanista Científico", 36, 14),
                    crearCurso("4° Medio TP", "Técnico Profesional", 22, 14)
                ];

                // Paso 2: Guardar en localStorage
                statusText.textContent = 'Paso 2/3: Guardando en navegador...';
                await new Promise(resolve => setTimeout(resolve, 500));

                const baseTimestamp = Date.now();
                const allCourses = cursosCompletos.map((curso, index) => ({
                    id: baseTimestamp + index, // ID único basado en timestamp
                    ...curso,
                    config: {
                        subject: curso.subject,
                        period: curso.period,
                        gradeType: "Chileno",
                        maxGrade: 7.0,
                        minGrade: 1.0,
                        passingGrade: 4.0,
                        passingPercentage: 60
                    }
                }));

                localStorage.setItem('allCourses', JSON.stringify(allCourses));
                localStorage.setItem('currentCourseId', '0');

                // Paso 3: Sincronizar con Neon Database
                statusText.textContent = 'Paso 3/3: Sincronizando con base de datos...';
                await new Promise(resolve => setTimeout(resolve, 500));

                const username = sessionStorage.getItem('username') || 'fconuva';
                
                const response = await fetch('/api/courses/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        courses: allCourses
                    })
                });

                if (!response.ok) {
                    throw new Error('Error al sincronizar con la base de datos');
                }

                // ¡ÉXITO!
                statusText.innerHTML = '<i class="fas fa-check-circle mr-2"></i>¡Migración completada! 8 cursos creados exitosamente.';
                
                // Cambiar color a verde
                statusDiv.querySelector('div').classList.remove('bg-green-50', 'border-green-200');
                statusDiv.querySelector('div').classList.add('bg-green-100', 'border-green-400');
                statusDiv.querySelector('p').classList.remove('text-green-800');
                statusDiv.querySelector('p').classList.add('text-green-900');

                // Mostrar botón de ir al sistema
                setTimeout(() => {
                    if (confirm('¡Migración exitosa! ¿Deseas ir al Sistema de Registro de Notas para ver los cursos?')) {
                        window.location.href = 'registro-notas.html';
                    } else {
                        // Recargar página
                        location.reload();
                    }
                }, 1500);

            } catch (error) {
                console.error('Error en migración:', error);
                statusText.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error: ' + error.message;
                statusDiv.querySelector('div').classList.remove('bg-green-50', 'border-green-200');
                statusDiv.querySelector('div').classList.add('bg-red-50', 'border-red-200');
                statusDiv.querySelector('p').classList.remove('text-green-800');
                statusDiv.querySelector('p').classList.add('text-red-800');
                
                // Reactivar botón
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-rocket mr-2"></i>REINTENTAR MIGRACIÓN';
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        function generarEstudiantes(cantidad) {
            const nombres = ['MATÍAS', 'VALENTINA', 'SEBASTIÁN', 'CATALINA', 'DIEGO', 'FERNANDA', 'BENJAMÍN', 'JAVIERA', 
                           'NICOLÁS', 'SOFÍA', 'LUCAS', 'ISIDORA', 'GABRIEL', 'MARTINA', 'TOMÁS', 'ANTONIA',
                           'FELIPE', 'EMILIA', 'JOAQUÍN', 'FLORENCIA', 'AGUSTÍN', 'CONSTANZA', 'VICENTE', 'AMANDA',
                           'CRISTÓBAL', 'JOSEFA', 'IGNACIO', 'MAITE', 'MAXIMILIANO', 'TRINIDAD', 'RODRIGO', 'CAMILA',
                           'ANDRÉS', 'ISABELLA', 'SANTIAGO', 'DANIELA', 'FRANCISCO', 'CAROLINA', 'PABLO', 'ROSARIO'];
            
            const apellidos = ['GONZÁLEZ', 'MUÑOZ', 'ROJAS', 'DÍAZ', 'PÉREZ', 'SOTO', 'CONTRERAS', 'SILVA', 'MARTÍNEZ',
                             'SEPÚLVEDA', 'MORALES', 'RODRÍGUEZ', 'LÓPEZ', 'FUENTES', 'HERNÁNDEZ', 'TORRES', 'ARAYA',
                             'FLORES', 'ESPINOZA', 'VALENZUELA', 'CASTILLO', 'REYES', 'VARGAS', 'NÚÑEZ', 'CARRASCO'];

            const estudiantes = [];
            for (let i = 0; i < cantidad; i++) {
                const nombre = nombres[i % nombres.length];
                const apellido1 = apellidos[Math.floor(Math.random() * apellidos.length)];
                const apellido2 = apellidos[Math.floor(Math.random() * apellidos.length)];
                
                estudiantes.push({
                    id: Date.now() + i,
                    number: i + 1,
                    lastName1: apellido1,
                    lastName2: apellido2,
                    name: nombre,
                    grades: [],
                    notes: '',
                    retired: false
                });
            }
            return estudiantes;
        }

        function generarTareas(cantidad) {
            const tiposTarea = ['Evaluación Escrita', 'Prueba', 'Trabajo Práctico', 'Exposición Oral', 'Análisis Literario', 'Ensayo', 'Comprensión Lectora'];
            const tareas = [];
            
            // Generar fechas realistas del año 2024
            const mesesBase = [3, 4, 5, 6, 8, 9, 10, 11]; // Marzo a Noviembre (sin vacaciones de verano ni julio)
            
            for (let i = 0; i < cantidad; i++) {
                const tipo = tiposTarea[i % tiposTarea.length];
                const mes = mesesBase[i % mesesBase.length];
                const dia = 5 + (i * 3) % 20; // Días entre 5 y 25
                const fecha = `2024-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                
                tareas.push({
                    id: Date.now() + i * 1000,
                    name: `${tipo} ${i + 1}`,
                    date: fecha,
                    nivel: null,
                    unidad: null,
                    oas: []
                });
            }
            return tareas;
        }

        // Cargar configuración de Profesor 2 si existe
        window.addEventListener('DOMContentLoaded', () => {
            try {
                const config = localStorage.getItem('profesor2_config');
                if (config) {
                    const data = JSON.parse(config);
                    const nameElement = document.getElementById('profesor2Name');
                    const infoElement = document.getElementById('profesor2Info');
                    
                    if (nameElement && data.teacherName) {
                        nameElement.textContent = data.teacherName;
                    }
                    
                    if (infoElement && (data.subject || data.courses)) {
                        let info = '<i class="fas fa-graduation-cap mr-1"></i>';
                        if (data.courses) info += data.courses;
                        if (data.subject) info += ` - ${data.subject}`;
                        infoElement.innerHTML = info;
                    }
                }
            } catch (e) {
                console.log('No hay configuración de Profesor 2');
            }
        });

    </script>

</body>
</html>
