<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico de Namespace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-white min-h-screen p-8">
    <!-- Auth Guard -->
    <script>
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'index.html';
        }
    </script>

    <div class="max-w-6xl mx-auto">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 mb-6">
            <h1 class="text-4xl font-bold text-center mb-2">
                <i class="fas fa-microscope mr-3 text-blue-400"></i>
                Diagn√≥stico de Separaci√≥n de Namespaces
            </h1>
            <p class="text-center text-gray-400 mb-4">Verificaci√≥n de aislamiento de datos por docente</p>
            <button onclick="ejecutarDiagnostico()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition">
                <i class="fas fa-play mr-2"></i>Ejecutar Diagn√≥stico Completo
            </button>
        </div>

        <div id="resultados" class="space-y-4"></div>
    </div>

    <script>
        const DOCENTES = [
            { id: 'francisco', nombre: 'Francisco Javier N√∫√±ez', color: 'indigo' },
            { id: 'javiera', nombre: 'Javiera Poblete', color: 'purple' },
            { id: 'docente3', nombre: 'Valentina', color: 'teal' },
            { id: 'docente4', nombre: 'Marcelo', color: 'orange' }
        ];

        function ejecutarDiagnostico() {
            const resultados = document.getElementById('resultados');
            resultados.innerHTML = '';

            // Panel 1: Resumen General
            const resumen = document.createElement('div');
            resumen.className = 'bg-gray-800 rounded-lg p-6';
            resumen.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-yellow-400">
                    <i class="fas fa-chart-bar mr-2"></i>Resumen General
                </h2>
                <div id="resumenGeneral" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            `;
            resultados.appendChild(resumen);

            // Panel 2: Detalles por Docente
            const detalles = document.createElement('div');
            detalles.className = 'bg-gray-800 rounded-lg p-6';
            detalles.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-green-400">
                    <i class="fas fa-users mr-2"></i>An√°lisis por Docente
                </h2>
                <div id="detallesDocentes" class="space-y-4"></div>
            `;
            resultados.appendChild(detalles);

            // Panel 3: Keys de localStorage
            const keys = document.createElement('div');
            keys.className = 'bg-gray-800 rounded-lg p-6';
            keys.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-red-400">
                    <i class="fas fa-database mr-2"></i>Todas las Keys en localStorage
                </h2>
                <div id="todasKeys" class="bg-gray-900 rounded p-4 overflow-x-auto"></div>
            `;
            resultados.appendChild(keys);

            // Ejecutar an√°lisis
            analizarResumen();
            analizarDocentes();
            listarTodasKeys();
        }

        function analizarResumen() {
            const resumenDiv = document.getElementById('resumenGeneral');
            let html = '';

            const totalKeys = Object.keys(localStorage).length;
            const keysRelevantes = Object.keys(localStorage).filter(k => 
                k.includes('_allCourses') || k.includes('_config') || k.includes('_currentCourseId')
            );

            html += `
                <div class="bg-blue-900/30 border border-blue-500 rounded-lg p-4">
                    <p class="text-blue-200 text-sm mb-1">Total Keys en localStorage</p>
                    <p class="text-3xl font-bold text-blue-400">${totalKeys}</p>
                </div>
                <div class="bg-green-900/30 border border-green-500 rounded-lg p-4">
                    <p class="text-green-200 text-sm mb-1">Keys de Docentes</p>
                    <p class="text-3xl font-bold text-green-400">${keysRelevantes.length}</p>
                </div>
            `;

            resumenDiv.innerHTML = html;
        }

        function analizarDocentes() {
            const detallesDiv = document.getElementById('detallesDocentes');
            let html = '';

            DOCENTES.forEach(docente => {
                const cursosKey = `${docente.id}_allCourses`;
                const configKey = `${docente.id}_config`;
                
                const cursosData = localStorage.getItem(cursosKey);
                const configData = localStorage.getItem(configKey);
                
                let cursos = [];
                let totalEstudiantes = 0;
                let config = null;

                if (cursosData) {
                    try {
                        cursos = JSON.parse(cursosData);
                        totalEstudiantes = cursos.reduce((sum, c) => sum + (c.students?.length || 0), 0);
                    } catch (e) {
                        console.error('Error parsing cursos:', e);
                    }
                }

                if (configData) {
                    try {
                        config = JSON.parse(configData);
                    } catch (e) {
                        console.error('Error parsing config:', e);
                    }
                }

                const colorClasses = {
                    indigo: 'border-indigo-500 bg-indigo-900/20',
                    purple: 'border-purple-500 bg-purple-900/20',
                    teal: 'border-teal-500 bg-teal-900/20',
                    orange: 'border-orange-500 bg-orange-900/20'
                };

                html += `
                    <div class="border-2 ${colorClasses[docente.color]} rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-${docente.color}-400">${docente.nombre}</h3>
                                <p class="text-gray-400 text-sm">ID: ${docente.id}</p>
                            </div>
                            <i class="fas fa-user-circle text-4xl text-${docente.color}-400"></i>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-gray-900/50 rounded p-3">
                                <p class="text-xs text-gray-400 mb-1">Cursos</p>
                                <p class="text-2xl font-bold ${cursos.length > 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${cursos.length}
                                </p>
                            </div>
                            <div class="bg-gray-900/50 rounded p-3">
                                <p class="text-xs text-gray-400 mb-1">Estudiantes</p>
                                <p class="text-2xl font-bold ${totalEstudiantes > 0 ? 'text-green-400' : 'text-gray-500'}">
                                    ${totalEstudiantes}
                                </p>
                            </div>
                        </div>

                        <div class="space-y-2 text-sm">
                            <div class="flex items-start">
                                <i class="fas fa-key text-${docente.color}-400 mt-1 mr-2 w-4"></i>
                                <div class="flex-1">
                                    <p class="text-gray-400">Storage Key:</p>
                                    <code class="text-${docente.color}-300 bg-gray-900/50 px-2 py-1 rounded">${cursosKey}</code>
                                </div>
                                <span class="${cursosData ? 'text-green-400' : 'text-red-400'} ml-2">
                                    ${cursosData ? '‚úì Existe' : '‚úó Vac√≠o'}
                                </span>
                            </div>

                            <div class="flex items-start">
                                <i class="fas fa-cog text-${docente.color}-400 mt-1 mr-2 w-4"></i>
                                <div class="flex-1">
                                    <p class="text-gray-400">Config:</p>
                                    ${config ? `
                                        <code class="text-${docente.color}-300 bg-gray-900/50 px-2 py-1 rounded block mt-1">
                                            ${config.teacherName || 'Sin nombre'} - ${config.subject || 'Sin asignatura'}
                                        </code>
                                    ` : `<p class="text-red-400">No configurado</p>`}
                                </div>
                                <span class="${config ? 'text-green-400' : 'text-yellow-400'} ml-2">
                                    ${config ? '‚úì OK' : '‚ö† Sin config'}
                                </span>
                            </div>

                            ${cursos.length > 0 ? `
                                <details class="mt-3">
                                    <summary class="cursor-pointer text-${docente.color}-400 hover:text-${docente.color}-300">
                                        <i class="fas fa-chevron-right mr-1"></i>Ver cursos (${cursos.length})
                                    </summary>
                                    <ul class="mt-2 space-y-1 pl-4">
                                        ${cursos.map(c => `
                                            <li class="text-gray-300 text-xs">
                                                <span class="text-${docente.color}-400">‚Ä¢</span> 
                                                ${c.name} 
                                                <span class="text-gray-500">(${c.students?.length || 0} estudiantes)</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            detallesDiv.innerHTML = html;
        }

        function listarTodasKeys() {
            const keysDiv = document.getElementById('todasKeys');
            const allKeys = Object.keys(localStorage).sort();

            let html = '<table class="w-full text-left text-sm"><thead><tr class="border-b border-gray-700"><th class="py-2 px-3">Key</th><th class="py-2 px-3">Tama√±o</th><th class="py-2 px-3">Tipo</th></tr></thead><tbody>';

            allKeys.forEach(key => {
                const value = localStorage.getItem(key);
                const size = value ? (value.length / 1024).toFixed(2) : '0';
                
                let tipo = 'String';
                let colorClass = 'text-gray-400';
                
                if (key.includes('_allCourses')) {
                    tipo = 'Cursos DB';
                    colorClass = 'text-green-400 font-bold';
                } else if (key.includes('_config')) {
                    tipo = 'Configuraci√≥n';
                    colorClass = 'text-blue-400 font-bold';
                } else if (key.includes('_currentCourseId')) {
                    tipo = 'Estado';
                    colorClass = 'text-yellow-400';
                }

                html += `
                    <tr class="border-b border-gray-800 hover:bg-gray-700/30">
                        <td class="py-2 px-3 ${colorClass}">${key}</td>
                        <td class="py-2 px-3 text-gray-500">${size} KB</td>
                        <td class="py-2 px-3 text-gray-500">${tipo}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            keysDiv.innerHTML = html;
        }

        // Auto-ejecutar al cargar
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(ejecutarDiagnostico, 500);
        });
    </script>
</body>
</html>
