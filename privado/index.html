<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4F46E5">
    <title>Acceso Privado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Tailwind CSS Reset & Base */
        *,::before,::after{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}
        html{line-height:1.5;-webkit-text-size-adjust:100%;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"}
        body{margin:0;line-height:inherit}
        h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}
        a{color:inherit;text-decoration:inherit}
        button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}
        button,select{text-transform:none}
        button,[type='button'],[type='submit']{-webkit-appearance:button;background-color:transparent;background-image:none}
        img,svg,video,canvas,audio,iframe,embed,object{display:block;vertical-align:middle}
        img,video{max-width:100%;height:auto}
        /* Tailwind Utilities */
        .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}
        .relative{position:relative}
        .flex{display:flex}
        .hidden{display:none}
        .min-h-screen{min-height:100vh}
        .w-full{width:100%}
        .max-w-md{max-width:28rem}
        .items-center{align-items:center}
        .justify-center{justify-content:center}
        .space-y-6>:not([hidden])~:not([hidden]){margin-top:1.5rem}
        .rounded-xl{border-radius:0.75rem}
        .rounded-lg{border-radius:0.5rem}
        .rounded-full{border-radius:9999px}
        .border{border-width:1px}
        .border-gray-300{border-color:#d1d5db}
        .border-green-300{border-color:#86efac}
        .border-red-300{border-color:#fca5a5}
        .bg-white{background-color:#fff}
        .bg-indigo-600{background-color:#4f46e5}
        .bg-green-100{background-color:#dcfce7}
        .bg-red-100{background-color:#fee2e2}
        .p-4{padding:1rem}
        .p-8{padding:2rem}
        .py-3{padding-top:0.75rem;padding-bottom:0.75rem}
        .px-4{padding-left:1rem;padding-right:1rem}
        .px-10{padding-left:2.5rem;padding-right:2.5rem}
        .pl-10{padding-left:2.5rem}
        .pr-10{padding-right:2.5rem}
        .mt-2{margin-top:0.5rem}
        .text-3xl{font-size:1.875rem;line-height:2.25rem}
        .text-sm{font-size:0.875rem;line-height:1.25rem}
        .text-lg{font-size:1.125rem;line-height:1.75rem}
        .text-center{text-align:center}
        .text-left{text-align:left}
        .font-bold{font-weight:700}
        .font-medium{font-medium:500}
        .text-gray-700{color:#374151}
        .text-gray-800{color:#1f2937}
        .text-gray-600{color:#4b5563}
        .text-white{color:#fff}
        .text-green-800{color:#166534}
        .text-red-800{color:#991b1b}
        .shadow-lg{box-shadow:0 10px 15px -3px rgb(0 0 0/0.1),0 4px 6px -4px rgb(0 0 0/0.1)}
        .hover\:bg-indigo-700:hover{background-color:#4338ca}
        .focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}
        .focus\:ring-2:focus{box-shadow:0 0 0 2px #fff,0 0 0 4px #4f46e5}
        .focus\:ring-indigo-500:focus{--tw-ring-color:#6366f1}
        .focus\:border-indigo-500:focus{border-color:#6366f1}
        .opacity-75{opacity:0.75}
        .cursor-not-allowed{cursor:not-allowed}
        .whitespace-pre-line{white-space:pre-line}
        .block{display:block}
        .transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(0.4,0,0.2,1);transition-duration:150ms}
        .duration-300{transition-duration:300ms}
        .animate-spin{animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        body {
            background-color: #f0f2f5;
            -webkit-overflow-scrolling: touch;
        }
        
        * {
            -webkit-tap-highlight-color: rgba(79, 70, 229, 0.2);
        }
        
        button, a, input {
            -webkit-tap-highlight-color: rgba(79, 70, 229, 0.3);
        }
        
        /* Prevenir zoom en inputs (iOS) */
        input {
            font-size: 16px !important;
        }
        
        button {
            min-height: 44px;
        }
        
        /* Optimizaciones m√≥vil */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            .max-w-md {
                max-width: 100% !important;
            }
            
            h1 {
                font-size: 1.5rem !important;
            }
            
            input {
                padding: 0.75rem 2.5rem !important;
            }
        }
        
        /* iOS safe area */
        @supports (-webkit-touch-callout: none) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">Acceso Privado</h1>
            <p class="mt-2 text-sm text-gray-600">Ingresa tus credenciales para continuar</p>
        </div>

        <form id="login-form" class="space-y-6">
            <div>
                <label for="username" class="text-sm font-medium text-gray-700 sr-only">Usuario</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fas fa-user text-gray-400"></i>
                    </span>
                    <input id="username" name="username" type="text" required autocomplete="username"
                        class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        placeholder="Usuario">
                </div>
            </div>

            <div>
                <label for="password" class="text-sm font-medium text-gray-700 sr-only">Contrase√±a</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fas fa-lock text-gray-400"></i>
                    </span>
                    <input id="password" name="password" type="password" required autocomplete="current-password"
                        class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        placeholder="Contrase√±a">
                    <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <div id="login-message" class="hidden p-4 rounded-lg text-sm font-medium"></div>

            <div>
                <button id="login-btn" type="submit"
                    class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-300">
                    <span id="btn-text">Ingresar</span>
                    <span id="btn-loading" class="hidden">
                        <i class="fas fa-spinner fa-spin"></i> Verificando...
                    </span>
                </button>
            </div>
        </form>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const loginBtn = document.getElementById('login-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoading = document.getElementById('btn-loading');
        const loginMessage = document.getElementById('login-message');

        // Redirect if already logged in
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            window.location.href = 'dashboard.html';
        }

        togglePasswordBtn.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.querySelector('i').className = `fas fa-eye${type === 'password' ? '' : '-slash'}`;
        });

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCzN4xNEE_hKshXbsVqLhWSnzet1pHwRh8",
            authDomain: "profe-blog.firebaseapp.com",
            databaseURL: "https://profe-blog-default-rtdb.firebaseio.com",
            projectId: "profe-blog",
            storageBucket: "profe-blog.firebasestorage.app",
            messagingSenderId: "305920739217",
            appId: "1:305920739217:web:2e08c7469d2988d8b3bc30"
        };

        // Initialize Firebase
        if (!firebase.apps || !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // Metadata de usuarios (roles y nombres) - NO INCLUYE CONTRASE√ëAS
        const USER_METADATA = {
            'fconuva@gmail.com': {
                role: 'admin',
                fullName: 'Francisco (Administrador)',
                username: 'fconuva'
            },
            'fconuva@gmail.com': {
                role: 'admin',
                fullName: 'Francisco (Administrador)',
                username: 'fconuva'
            },
            'alicia@profe.cl': {
                role: 'teacher',
                fullName: 'Alicia (Profesora)',
                username: 'alicia'
            },
            'joselin@profe.cl': {
                role: 'teacher',
                fullName: 'Joselin (Profesora)',
                username: 'joselin'
            },
            'pia@profe.cl': {
                role: 'teacher',
                fullName: 'Pia (Profesora)',
                username: 'pia'
            }
        };

        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            setLoadingState(true);

            const username = usernameInput.value.trim().toLowerCase();
            const password = passwordInput.value;

            // Convertir username a email para Firebase Auth
            let email;
            if (username.includes('@')) {
                email = username;
            } else if (username === 'fconuva') {
                email = 'fconuva@gmail.com';
            } else {
                email = `${username}@profe.cl`;
            }

            try {
                // Intentar login con Firebase Auth
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Obtener metadata del usuario
                const metadata = USER_METADATA[email];
                
                if (metadata) {
                    showMessage(`¬°Bienvenida ${metadata.fullName}! Redirigiendo...`, 'success');
                    
                    // Guardar sesi√≥n
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('username', metadata.username);
                    sessionStorage.setItem('userRole', metadata.role);
                    sessionStorage.setItem('userFullName', metadata.fullName);
                    sessionStorage.setItem('userEmail', email);
                    
                    // Registrar dispositivo
                    const deviceInfo = {
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString(),
                        email: email
                    };
                    
                    // Intentar guardar historial (no cr√≠tico si falla)
                    try {
                        await database.ref(`admin/login_history/${metadata.username}`).push(deviceInfo);
                    } catch (historyError) {
                        console.warn('No se pudo guardar historial de login (no cr√≠tico):', historyError);
                    }
                    
                    setTimeout(() => {
                        window.location.href = '/privado/dashboard.html';
                    }, 1000);
                } else {
                    showMessage('Usuario no autorizado.', 'error');
                    await firebase.auth().signOut();
                    setLoadingState(false);
                }
            } catch (error) {
                console.error('Error de autenticaci√≥n:', error);
                
                if (error.code === 'auth/configuration-not-found') {
                    showMessage('‚ö†Ô∏è Firebase Auth no configurado correctamente. Pasos:\n\n' +
                               '1. Firebase Console ‚Üí Authentication ‚Üí Sign-in method\n' +
                               '2. Habilitar "Email/Password"\n' +
                               '3. Agregar dominios autorizados en Settings\n' +
                               '4. Verificar que la API Key no tenga restricciones que bloqueen el dominio\n\n' +
                               'Contacta al administrador.', 'error');
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-login-credentials' || error.code === 'auth/invalid-credential') {
                    showMessage('‚ùå Usuario o contrase√±a incorrectos.\n\n' +
                               'üí° Si eres administrador y es la primera vez:\n' +
                               '1. Ve a Firebase Console ‚Üí Authentication ‚Üí Users\n' +
                               '2. Click "Add User"\n' +
                               '3. Email: ' + (username.includes('@') ? username : username + '@profe.cl') + '\n' +
                               '4. Contrase√±a: [tu contrase√±a]\n' +
                               '5. Intenta nuevamente', 'error');
                } else if (error.code === 'auth/too-many-requests') {
                    showMessage('üö´ Demasiados intentos fallidos. Intenta m√°s tarde.', 'error');
                } else if (error.code === 'auth/network-request-failed') {
                    showMessage('üåê Error de conexi√≥n. Verifica tu internet.', 'error');
                } else {
                    showMessage(`‚ùå Error de autenticaci√≥n: ${error.code || error.message}\n\nSi el error persiste, contacta al administrador.`, 'error');
                }
                
                setLoadingState(false);
            }
        });

        function showMessage(message, type) {
            // Preservar saltos de l√≠nea en el mensaje
            loginMessage.innerHTML = message.replace(/\n/g, '<br>');
            loginMessage.className = 'p-4 rounded-lg text-sm font-medium block whitespace-pre-line text-left ';
            if (type === 'success') {
                loginMessage.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
            } else {
                loginMessage.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
            }
        }

        function setLoadingState(loading) {
            if (loading) {
                btnText.classList.add('hidden');
                btnLoading.classList.remove('hidden');
                loginBtn.disabled = true;
                loginBtn.classList.add('opacity-75', 'cursor-not-allowed');
            } else {
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
                loginBtn.disabled = false;
                loginBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }
    });
    </script>

</body>
</html>
