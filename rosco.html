<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rosco de Pasapalabra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Orbitron:wght@400;700&family=Concert+One&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Base --- */
        html, body { height: 100%; }
        body {
            font-family: 'Montserrat', sans-serif;
            touch-action: manipulation;
            transition: background-color 0.5s, color 0.5s;
            display: flex;
            flex-direction: column;
        }
        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        /* --- Variables de Temas Mejoradas --- */
        :root {
            --bg-primary: #0f172a; 
            --bg-secondary: #1e293b; 
            --bg-tertiary: #334155;
            --text-primary: #f8fafc; 
            --text-secondary: #94a3b8;
            --accent-color: #fbbf24; 
            --correct-color: #10b981; 
            --incorrect-color: #ef4444; 
            --pending-color: #3b82f6;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --border-color: #475569;
        }
        .theme-light {
            --bg-primary: #f8fafc; 
            --bg-secondary: #ffffff; 
            --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a; 
            --text-secondary: #475569;
            --accent-color: #f59e0b; 
            --correct-color: #059669; 
            --incorrect-color: #dc2626; 
            --pending-color: #2563eb;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-color: #cbd5e1;
        }
        .theme-kitty {
            font-family: 'Concert One', cursive;
            --bg-primary: #fdf2f8; 
            --bg-secondary: #ffffff; 
            --bg-tertiary: #fce7f3;
            --text-primary: #831843; 
            --text-secondary: #be185d;
            --accent-color: #ec4899; 
            --correct-color: #a21caf; 
            --incorrect-color: #be123c; 
            --pending-color: #7c3aed;
            --shadow-color: rgba(236, 72, 153, 0.2);
            --border-color: #f9a8d4;
        }
        .theme-cyberpunk {
            font-family: 'Orbitron', sans-serif;
            --bg-primary: #0a0014; 
            --bg-secondary: #1a0033; 
            --bg-tertiary: #2d0066;
            --text-primary: #00ffff; 
            --text-secondary: #66ccff;
            --accent-color: #ff0080; 
            --correct-color: #00ff80; 
            --incorrect-color: #ff4040; 
            --pending-color: #8080ff;
            --shadow-color: rgba(255, 0, 128, 0.3);
            --border-color: #6600cc;
            text-shadow: 0 0 3px var(--accent-color);
        }

        /* --- Aplicación de Temas --- */
        body { 
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary); 
        }
        .bg-themed-secondary { 
            background: var(--bg-secondary); 
            border: 1px solid var(--border-color);
        }
        .text-themed-primary { color: var(--text-primary); }
        .text-themed-secondary { color: var(--text-secondary); }
        .border-themed-accent { border-color: var(--accent-color); }
        .text-themed-accent { color: var(--accent-color); }
        .shadow-themed-accent { box-shadow: 0 0 20px var(--accent-color); }
        .file-themed-accent { 
            background: linear-gradient(145deg, var(--accent-color), #fbbf24); 
            color: var(--bg-primary); 
            transition: all 0.3s ease;
        }
        .file-themed-accent:hover { 
            filter: brightness(1.1); 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        .button-themed-accent { 
            background: linear-gradient(145deg, var(--accent-color), #fbbf24); 
            color: var(--bg-primary); 
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        .button-themed-accent:hover { 
            filter: brightness(1.1); 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow-color);
        }

        /* --- Mejoras para Móviles --- */
        @media (max-width: 768px) {
            .rosco-container {
                max-width: 320px;
            }
            .letter-cell {
                width: 16%;
                height: 16%;
                font-size: clamp(0.8rem, 4vw, 1.2rem);
            }
            #game-controls {
                flex-direction: column;
                gap: 2rem;
            }
            .player-container {
                margin-bottom: 1rem;
            }
        }

        @media (max-width: 480px) {
            .rosco-container {
                max-width: 280px;
            }
            .letter-cell {
                width: 18%;
                height: 18%;
            }
        }

        .player-container { 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 4px solid var(--border-color); 
            cursor: pointer; 
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
        }
        .player-container:not(.active) { 
            opacity: 0.7; 
            transform: scale(0.95);
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        .player-container:not(.active):hover {
            opacity: 0.85;
            transform: scale(0.97);
        }
        .player-container.active { 
            border-color: var(--accent-color); 
            box-shadow: 0 0 30px var(--accent-color), 0 8px 25px var(--shadow-color); 
            opacity: 1; 
            transform: scale(1);
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
        }
        .rosco-container { 
            position: relative; 
            width: 100%; 
            max-width: 400px;
            padding-top: 100%; 
            margin: 1rem auto; 
            border-radius: 50%;
            background: radial-gradient(circle at center, var(--bg-tertiary) 60%, var(--bg-secondary) 100%);
            box-shadow: inset 0 0 20px var(--shadow-color), 0 4px 15px var(--shadow-color);
        }
        .letter-cell {
            position: absolute; 
            width: 14%; 
            height: 14%; 
            border-radius: 50%; 
            display: flex;
            justify-content: center; 
            align-items: center; 
            font-size: clamp(0.9rem, 3vw, 1.4rem);
            font-weight: 700; 
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
            border: 3px solid var(--border-color);
            color: var(--text-primary); 
            text-shadow: 0 1px 2px var(--shadow-color); 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            transform-origin: center;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        .letter-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        @keyframes pulse { 
            0%, 100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 20px var(--accent-color); } 
            50% { transform: translate(-50%, -50%) scale(1.1); box-shadow: 0 0 30px var(--accent-color), inset 0 0 10px rgba(255,255,255,0.1); } 
        }
        @keyframes correctBounce {
            0% { transform: translate(-50%, -50%) scale(1); }
            25% { transform: translate(-50%, -50%) scale(1.2) rotate(5deg); }
            50% { transform: translate(-50%, -50%) scale(1.1) rotate(-3deg); }
            75% { transform: translate(-50%, -50%) scale(1.15) rotate(2deg); }
            100% { transform: translate(-50%, -50%) scale(1.1); }
        }
        @keyframes incorrectShake {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-50%, -50%) rotate(-2deg); }
            20%, 40%, 60%, 80% { transform: translate(-50%, -50%) rotate(2deg); }
        }
        @keyframes pendingGlow {
            0%, 100% { box-shadow: 0 0 15px var(--pending-color); }
            50% { box-shadow: 0 0 25px var(--pending-color), inset 0 0 10px rgba(255,255,255,0.1); }
        }
        
        .letter-cell.active { 
            background: linear-gradient(145deg, var(--accent-color), #fbbf24); 
            border-color: var(--accent-color); 
            color: var(--bg-primary);
            animation: pulse 1.5s ease-in-out infinite; 
            z-index: 10;
        }
        .letter-cell.correct { 
            background: linear-gradient(145deg, var(--correct-color), #059669); 
            border-color: var(--correct-color); 
            color: white; 
            animation: correctBounce 0.6s ease-out; 
            transform: translate(-50%, -50%) scale(1.1);
        }
        .letter-cell.incorrect { 
            background: linear-gradient(145deg, var(--incorrect-color), #dc2626); 
            border-color: var(--incorrect-color); 
            color: white; 
            animation: incorrectShake 0.6s ease-out; 
            transform: translate(-50%, -50%) scale(1.05);
        }
        .letter-cell.pending { 
            background: linear-gradient(145deg, var(--pending-color), #1d4ed8); 
            border-color: var(--pending-color); 
            color: white; 
            animation: pendingGlow 2s ease-in-out infinite;
        }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--correct-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        #instructions-panel {
            max-height: 0;
            overflow: hidden;
            padding-top: 0;
            padding-bottom: 0;
            transition: max-height 0.5s ease-out, padding 0.5s ease-out;
        }
        #instructions-panel.open {
            max-height: 1000px;
            padding-top: 1rem;
            padding-bottom: 1rem;
            transition: max-height 1s ease-in, padding 0.5s ease-in;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-sm border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo/Name -->
                <a href="/" class="text-2xl font-bold text-gray-800 hover:text-blue-600 transition-colors">
                    Francisco Núñez
                </a>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="/" class="text-gray-700 hover:text-blue-600 transition-colors font-medium">Inicio</a>
                    <a href="/portafolio" class="text-gray-700 hover:text-blue-600 transition-colors font-medium">Portafolio</a>
                    <a href="/blog" class="text-gray-700 hover:text-blue-600 transition-colors font-medium">Blog</a>
                    <a href="/contacto" class="text-gray-700 hover:text-blue-600 transition-colors font-medium">Contacto</a>
                    <a href="/galeria" class="text-gray-700 hover:text-blue-600 transition-colors font-medium">Galería</a>
                    <a href="/generador-cv" class="text-gray-700 hover:text-blue-600 transition-colors font-medium">Generador CV</a>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobile-menu-button" class="md:hidden text-gray-700 hover:text-blue-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobile-menu" class="hidden md:hidden mt-4 pb-4 border-t border-gray-200">
                <div class="flex flex-col space-y-4 pt-4">
                    <a href="/" class="text-gray-700 hover:text-blue-600 transition-colors font-medium">Inicio</a>
                    <a href="/portafolio" class="text-gray-700 hover:text-blue-600 transition-colors font-medium">Portafolio</a>
                    <a href="/blog" class="text-gray-700 hover:text-blue-600 transition-colors font-medium">Blog</a>
                    <a href="/contacto" class="text-gray-700 hover:text-blue-600 transition-colors font-medium">Contacto</a>
                    <a href="/galeria" class="text-gray-700 hover:text-blue-600 transition-colors font-medium">Galería</a>
                    <a href="/generador-cv" class="text-gray-700 hover:text-blue-600 transition-colors font-medium">Generador CV</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="p-2 md:p-4">
        <!-- Pantalla de Configuración -->
        <div id="setup-screen" class="w-full max-w-md p-6 md:p-8 bg-themed-secondary rounded-2xl shadow-lg">
            <h1 class="text-3xl font-bold text-center text-themed-accent mb-6">Configurar Partida</h1>
            
            <div class="mb-4">
                <button id="instructions-toggle" class="w-full flex justify-between items-center p-3 bg-gray-600 rounded-lg text-white font-bold text-left">
                    <span>Instrucciones de Uso</span>
                    <span id="instructions-icon" class="text-2xl font-mono"> + </span>
                </button>
                <div id="instructions-panel" class="bg-gray-700 rounded-lg text-sm text-gray-300">
                    <ul class="space-y-3 list-disc list-inside">
                         <li><strong>Control Manual:</strong> ¡Ahora puedes elegir cualquier letra del rosco presionando la tecla correspondiente (A-Z, Ñ) para ver su pregunta!</li>
                         <li><strong>Función de Corrección:</strong> Si te equivocas al marcar una respuesta, simplemente vuelve a presionar la tecla de esa letra para seleccionarla de nuevo y cambiar su estado.</li>
                        <li><strong>Controles de Respuesta:</strong>
                            <ul class="ml-6 space-y-1">
                                <li><kbd class="px-2 py-1 bg-green-500 rounded">1</kbd> = Marcar como Correcto.</li>
                                <li><kbd class="px-2 py-1 bg-red-500 rounded">2</kbd> = Marcar como Incorrecto.</li>
                                <li><kbd class="px-2 py-1 bg-blue-500 rounded">Espacio</kbd> = Pasapalabra (dejar pendiente).</li>
                            </ul>
                        </li>
                        <li><strong>Multijugador:</strong> Para cambiar de turno, haz clic en el rosco del jugador que quieras que juegue.</li>
                    </ul>
                </div>
            </div>

            <div class="mb-4">
                <label for="theme-selector" class="block text-lg font-medium mb-2 text-themed-primary">Tema:</label>
                <select id="theme-selector" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    <option value="theme-dark">Oscuro</option>
                    <option value="theme-light">Claro</option>
                    <option value="theme-kitty">Hello Kitty</option>
                    <option value="theme-cyberpunk">Cyberpunk</option>
                </select>
            </div>

            <div class="mb-4">
                <label for="activity-title" class="block text-lg font-medium mb-2 text-themed-primary">Título (Opcional):</label>
                <input type="text" id="activity-title" placeholder="Ej: Repaso de Historia" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>

            <div class="mb-4">
                <label for="num-players" class="block text-lg font-medium mb-2 text-themed-primary">Jugadores:</label>
                <select id="num-players" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    <option value="1">1 Jugador</option> <option value="2">2 Jugadores</option> <option value="3">3 Jugadores</option> <option value="4">4 Jugadores</option>
                </select>
            </div>
            
            <div id="player-names-container" class="mb-4 space-y-2"></div>

            <div class="mb-6">
                <label for="rosco-selector" class="block text-lg font-medium mb-2 text-themed-primary">Elige un Rosco:</label>
                <select id="rosco-selector" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    <option value="default">Rosco por Defecto</option>
                    <optgroup label="Ciencias">
                        <option value="ciencias_biologia">Biología Humana</option>
                        <option value="ciencias_astro">Astronomía y Física</option>
                    </optgroup>
                    <optgroup label="Historia">
                        <option value="historia_universal">Historia Universal</option>
                        <option value="historia_chile">Historia de Chile</option>
                    </optgroup>
                    <optgroup label="Matemáticas">
                        <option value="mat_conceptos">Conceptos Generales</option>
                        <option value="mat_geo">Geometría y Álgebra</option>
                    </optgroup>
                    <optgroup label="Lenguaje">
                        <option value="leng_vocabulario">Vocabulario Avanzado</option>
                        <option value="leng_teoria">Figuras Literarias y Teoría</option>
                    </optgroup>
                    <option value="upload">Subir mi propio archivo...</option>
                </select>
            </div>
            
            <div id="csv-upload-container" class="mb-6 hidden">
                <label for="csv-file" class="block text-lg font-medium mb-2 text-themed-primary">Subir Rosco Personalizado (.csv):</label>
                <input type="file" id="csv-file" accept=".csv" class="w-full text-sm text-themed-secondary file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file-themed-accent">
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="flex items-center justify-between bg-gray-700 p-2 rounded-lg">
                    <span class="text-md font-medium text-white">Sonido:</span>
                    <label class="switch"><input type="checkbox" id="use-sound" checked><span class="slider"></span></label>
                </div>
                <div class="flex items-center justify-between bg-gray-700 p-2 rounded-lg">
                    <span class="text-md font-medium text-white">Tiempo:</span>
                    <label class="switch"><input type="checkbox" id="use-timer" checked><span class="slider"></span></label>
                </div>
                <div class="flex items-center justify-between bg-gray-700 p-2 rounded-lg col-span-2">
                    <span class="text-md font-medium text-white">Mostrar Respuesta al Fallar:</span>
                    <label class="switch"><input type="checkbox" id="reveal-answer" checked><span class="slider"></span></label>
                </div>
            </div>
            
            <div id="time-input-container" class="mb-8">
                <label for="custom-time" class="block text-lg font-medium mb-2 text-themed-primary">Tiempo por jugador (segundos):</label>
                <input type="number" id="custom-time" value="150" min="10" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>

            <button id="start-btn" class="w-full button-themed-accent font-bold py-3 px-6 rounded-lg text-xl transition">
                Comenzar Juego
            </button>
            
            <button id="download-template-btn" class="w-full mt-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">
                Descargar Plantilla (CSV)
            </button>
        </div>

        <!-- Contenedor del Juego -->
        <div id="game-container" class="hidden w-full h-full flex flex-col">
            <h1 id="game-title" class="text-4xl font-bold text-center text-themed-accent mb-4 hidden"></h1>
            <div id="game-controls" class="w-full max-w-lg mx-auto my-4 p-3 bg-themed-secondary rounded-lg flex flex-col md:flex-row items-center gap-4">
                <div class="flex-1 w-full md:w-auto">
                    <label for="scale-slider" class="font-bold text-themed-primary">Tamaño Rosco:</label>
                    <input type="range" id="scale-slider" min="0.5" max="1.2" value="1" step="0.05" class="w-full">
                </div>
                <div class="flex-1 w-full md:w-auto">
                    <label for="font-size-slider" class="font-bold text-themed-primary">Tamaño Pista:</label>
                    <input type="range" id="font-size-slider" min="14" max="28" value="16" step="1" class="w-full">
                </div>
            </div>
            <div id="game-board" class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-7xl mx-auto" style="transition: transform 0.3s ease;"></div>
            <div class="text-center mt-6 flex flex-wrap justify-center gap-4">
                 <button id="download-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition hidden">
                    Resultados
                </button>
                <button id="back-to-setup-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition">
                    Nueva Partida
                </button>
            </div>
        </div>
    </main>

    <footer class="text-center text-xs text-themed-secondary p-4">
        <p>&copy; &reg; Todos los derechos reservados. Autor: Francisco Javier Núñez Valenzuela</p>
    </footer>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Elementos del DOM ---
        const setupScreen = document.getElementById('setup-screen');
        const gameContainer = document.getElementById('game-container');
        const startBtn = document.getElementById('start-btn');
        const numPlayersSelect = document.getElementById('num-players');
        const useTimerCheckbox = document.getElementById('use-timer');
        const useSoundCheckbox = document.getElementById('use-sound');
        const revealAnswerCheckbox = document.getElementById('reveal-answer');
        const themeSelector = document.getElementById('theme-selector');
        const playerNamesContainer = document.getElementById('player-names-container');
        const gameBoard = document.getElementById('game-board');
        const downloadBtn = document.getElementById('download-btn');
        const backToSetupBtn = document.getElementById('back-to-setup-btn');
        const downloadTemplateBtn = document.getElementById('download-template-btn');
        const activityTitleInput = document.getElementById('activity-title');
        const roscoSelector = document.getElementById('rosco-selector');
        const csvUploadContainer = document.getElementById('csv-upload-container');
        const csvFileInput = document.getElementById('csv-file');
        const gameTitle = document.getElementById('game-title');
        const instructionsToggle = document.getElementById('instructions-toggle');
        const instructionsPanel = document.getElementById('instructions-panel');
        const instructionsIcon = document.getElementById('instructions-icon');
        const timeInputContainer = document.getElementById('time-input-container');
        const customTimeInput = document.getElementById('custom-time');
        const scaleSlider = document.getElementById('scale-slider');
        const fontSizeSlider = document.getElementById('font-size-slider');

        // --- Configuración de Audio Mejorada ---
        let synth, bellSynth, bassSynth, mainSynth;
        
        const initAudio = async () => {
            if (!gameSettings.useSound) return;
            await Tone.start();
            
            // Sintetizador principal para efectos melódicos
            mainSynth = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 }
            }).toDestination();
            
            // Sintetizador para sonidos de campana (correcto)
            bellSynth = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.2, release: 0.8 }
            }).toDestination();
            
            // Sintetizador para sonidos graves (incorrecto)
            bassSynth = new Tone.Synth({
                oscillator: { type: 'sawtooth' },
                envelope: { attack: 0.01, decay: 0.3, sustain: 0.0, release: 0.1 }
            }).toDestination();
        };

        const sound = {
            correct: () => {
                if(!gameSettings.useSound || !bellSynth) return;
                const now = Tone.now();
                // Secuencia melódica de éxito
                bellSynth.triggerAttackRelease("C5", "16n", now);
                bellSynth.triggerAttackRelease("E5", "16n", now + 0.1);
                bellSynth.triggerAttackRelease("G5", "8n", now + 0.2);
            },
            incorrect: () => {
                if(!gameSettings.useSound || !bassSynth) return;
                const now = Tone.now();
                // Sonido descendente de error
                bassSynth.triggerAttackRelease("F3", "16n", now);
                bassSynth.triggerAttackRelease("D3", "8n", now + 0.1);
            },
            pasapalabra: () => {
                if(!gameSettings.useSound || !mainSynth) return;
                // Sonido neutral y rápido
                mainSynth.triggerAttackRelease("G4", "32n");
            },
            timesUp: () => {
                if(!gameSettings.useSound || !bassSynth) return;
                const now = Tone.now();
                // Alarma urgente
                bassSynth.triggerAttackRelease("C3", "8n", now);
                bassSynth.triggerAttackRelease("C3", "8n", now + 0.15);
                bassSynth.triggerAttackRelease("C3", "4n", now + 0.3);
            },
            letterSelect: () => {
                if(!gameSettings.useSound || !mainSynth) return;
                // Sonido sutil al seleccionar letra
                mainSynth.triggerAttackRelease("A4", "32n");
            },
            gameStart: () => {
                if(!gameSettings.useSound || !bellSynth) return;
                const now = Tone.now();
                // Melodía de inicio
                bellSynth.triggerAttackRelease("C4", "16n", now);
                bellSynth.triggerAttackRelease("E4", "16n", now + 0.1);
                bellSynth.triggerAttackRelease("G4", "8n", now + 0.2);
            }
        };

        const speech = new SpeechSynthesisUtterance();
        speech.lang = 'es-ES';
        speech.rate = 1.1;

        function speak(text) {
            if(!gameSettings.useSound) return;
            window.speechSynthesis.cancel();
            speech.text = text;
            window.speechSynthesis.speak(speech);
        }

        // --- Datos del Juego ---
        const PRELOADED_ROSCOS = {
            default: [
                { letter: 'A', question: 'Empieza por A: Objeto que se usa para lanzar flechas.', answer: 'ARCO' },
                { letter: 'B', question: 'Empieza por B: Embarcación pequeña, generalmente sin cubierta.', answer: 'BOTE' },
                { letter: 'C', question: 'Empieza por C: Vivienda, especialmente la propia.', answer: 'CASA' },
                { letter: 'D', question: 'Empieza por D: Figura con diez lados.', answer: 'DECAGONO' },
                { letter: 'E', question: 'Empieza por E: Animal paquidermo con trompa.', answer: 'ELEFANTE' },
                { letter: 'F', question: 'Empieza por F: Fenómeno luminoso que acompaña al rayo.', answer: 'FUEGO' },
                { letter: 'G', question: 'Empieza por G: Utensilio de goma para borrar lo escrito.', answer: 'GOMA' },
                { letter: 'H', question: 'Contiene la H: Cohete espacial que transportó al hombre a la Luna.', answer: 'APOLO' },
                { letter: 'I', question: 'Empieza por I: Territorio rodeado de agua por todas partes.', answer: 'ISLA' },
                { letter: 'J', question: 'Empieza por J: Líquido que se extrae de las frutas o verduras.', answer: 'JUGO' },
                { letter: 'L', question: 'Empieza por L: Objeto que se utiliza para leer en la oscuridad.', answer: 'LAMPARA' },
                { letter: 'M', question: 'Empieza por M: Instrumento musical de viento, de metal.', answer: 'MARACA' },
                { letter: 'N', question: 'Empieza por N: Cuna de un río.', answer: 'NACIMIENTO' },
                { letter: 'Ñ', question: 'Contiene la Ñ: El primer mes del año.', answer: 'AÑO' },
                { letter: 'O', question: 'Empieza por O: Mamífero plantígrado, de gran tamaño y pelaje pardo.', answer: 'OSO' },
                { letter: 'P', question: 'Empieza por P: Animal mamífero roedor, con el cuerpo cubierto de púas.', answer: 'PUERCOESPIN' },
                { letter: 'Q', question: 'Contiene la Q: Líquido transparente, inodoro e insípido.', answer: 'AQUA' },
                { letter: 'R', question: 'Empieza por R: Soberano de un reino.', answer: 'REY' },
                { letter: 'S', question: 'Empieza por S: Asiento con respaldo, por lo general con cuatro patas.', answer: 'SILLA' },
                { letter: 'T', question: 'Empieza por T: Vehículo automóvil de grandes dimensiones.', answer: 'TRACTOR' },
                { letter: 'U', question: 'Empieza por U: Fruto comestible de la vid.', answer: 'UVA' },
                { letter: 'V', question: 'Empieza por V: Prenda de vestir, por lo común con mangas, que cubre el torso.', answer: 'VESTIDO' },
                { letter: 'X', question: 'Contiene la X: Que tiene éxito.', answer: 'EXITOSO' },
                { letter: 'Y', question: 'Contiene la Y: Línea que divide un país de otro.', answer: 'RAYA' },
                { letter: 'Z', question: 'Empieza por Z: Parte de la botánica que trata de los vegetales.', answer: 'ZOO' }
            ],
            ciencias_biologia: [
                { letter: 'A', question: 'Empieza por A: Vaso sanguíneo que lleva la sangre desde el corazón a las demás partes del cuerpo.', answer: 'ARTERIA' },
                { letter: 'B', question: 'Empieza por B: Cada uno de los dos conductos en que se divide la tráquea y que entran en los pulmones.', answer: 'BRONQUIO' },
                { letter: 'C', question: 'Empieza por C: Órgano principal del sistema circulatorio que bombea la sangre.', answer: 'CORAZON' },
                { letter: 'D', question: 'Empieza por D: Capa más externa de la piel.', answer: 'DERMIS' },
                { letter: 'E', question: 'Empieza por E: Conjunto de huesos que sostiene el cuerpo humano.', answer: 'ESQUELETO' },
                { letter: 'F', question: 'Empieza por F: Hueso más largo del cuerpo humano, situado en el muslo.', answer: 'FEMUR' },
                { letter: 'G', question: 'Empieza por G: Células reproductoras masculinas o femeninas.', answer: 'GAMETOS' },
                { letter: 'H', question: 'Empieza por H: Órgano que filtra la sangre y produce la bilis.', answer: 'HIGADO' },
                { letter: 'I', question: 'Empieza por I: Órgano responsable de la producción de insulina.', answer: 'ISLOTES' },
                { letter: 'J', question: 'Contiene la J: Tejido que conecta los músculos con los huesos.', answer: 'TEJIDO' },
                { letter: 'L', question: 'Empieza por L: Glóbulos blancos, células de la sangre que combaten infecciones.', answer: 'LEUCOCITOS' },
                { letter: 'M', question: 'Empieza por M: Tejido contráctil que permite el movimiento del cuerpo.', answer: 'MUSCULO' },
                { letter: 'N', question: 'Empieza por N: Célula fundamental del sistema nervioso.', answer: 'NEURONA' },
                { letter: 'Ñ', question: 'Contiene la Ñ: Estructura en el ojo que enfoca la luz en la retina.', answer: 'CRISTALIÑO' },
                { letter: 'O', question: 'Empieza por O: Sentido que permite percibir los olores.', answer: 'OLFATO' },
                { letter: 'P', question: 'Empieza por P: Órgano glandular que produce enzimas para la digestión y la hormona insulina.', answer: 'PANCREAS' },
                { letter: 'Q', question: 'Contiene la Q: Líquido cefalorraquídeo, que protege el cerebro.', answer: 'LIQUIDO' },
                { letter: 'R', question: 'Empieza por R: Órganos principales del sistema respiratorio, encargados del intercambio de gases.', answer: 'RIÑONES' },
                { letter: 'S', question: 'Empieza por S: Fluido rojo que circula por las arterias y venas.', answer: 'SANGRE' },
                { letter: 'T', question: 'Empieza por T: Hueso de la pierna, paralelo al peroné.', answer: 'TIBIA' },
                { letter: 'U', question: 'Empieza por U: Conducto que lleva la orina desde la vejiga al exterior.', answer: 'URETRA' },
                { letter: 'V', question: 'Empieza por V: Cada uno de los huesos que forman la columna vertebral.', answer: 'VERTEBRA' },
                { letter: 'X', question: 'Contiene la X: Proceso de respiración que implica inhalar y exhalar.', answer: 'OXIGENACION' },
                { letter: 'Y', question: 'Contiene la Y: Célula resultante de la unión del gameto masculino con el femenino.', answer: 'CIGOTO' },
                { letter: 'Z', question: 'Contiene la Z: Enzima digestiva presente en la saliva.', answer: 'AMILASA' }
            ],
            ciencias_astro: [
                { letter: 'A', question: 'Empieza por A: Cuerpo celeste rocoso, más pequeño que un planeta, que gira alrededor del Sol.', answer: 'ASTEROIDE' },
                { letter: 'B', question: 'Empieza por B: Teoría que explica el origen del universo a partir de una gran explosión.', answer: 'BIGBANG' },
                { letter: 'C', question: 'Empieza por C: Fuerza que atrae dos cuerpos con masa.', answer: 'GRAVEDAD' },
                { letter: 'D', question: 'Empieza por D: Medida de la cantidad de materia en un volumen determinado.', answer: 'DENSIDAD' },
                { letter: 'E', question: 'Empieza por E: Astro que gira alrededor de un planeta.', answer: 'SATELITE' },
                { letter: 'F', question: 'Empieza por F: Ciencia que estudia las propiedades de la materia y la energía.', answer: 'FISICA' },
                { letter: 'G', question: 'Empieza por G: Agrupación de miles de millones de estrellas, como la Vía Láctea.', answer: 'GALAXIA' },
                { letter: 'H', question: 'Empieza por H: Unidad de frecuencia que equivale a un ciclo por segundo.', answer: 'HERCIO' },
                { letter: 'I', question: 'Empieza por I: Resistencia de un cuerpo a cambiar su estado de reposo o movimiento.', answer: 'INERCIA' },
                { letter: 'J', question: 'Empieza por J: El planeta más grande del sistema solar.', answer: 'JUPITER' },
                { letter: 'L', question: 'Empieza por L: Fenómeno que ocurre cuando la Tierra se interpone entre el Sol y la Luna.', answer: 'ECLIPSE' },
                { letter: 'M', question: 'Empieza por M: Partícula subatómica con carga eléctrica negativa que orbita el núcleo de un átomo.', answer: 'ELECTRON' },
                { letter: 'N', question: 'Empieza por N: Nube inmensa de gas y polvo en el espacio, cuna de estrellas.', answer: 'NEBULOSA' },
                { letter: 'Ñ', question: 'Contiene la Ñ: Fenómeno ondulatorio que se produce por la vibración de un cuerpo.', answer: 'SONIDO' },
                { letter: 'O', question: 'Empieza por O: Trayectoria que describe un cuerpo alrededor de otro bajo la influencia de una fuerza central.', answer: 'ORBITA' },
                { letter: 'P', question: 'Empieza por P: El octavo planeta del sistema solar, conocido por sus vientos supersónicos.', answer: 'NEPTUNO' },
                { letter: 'Q', question: 'Contiene la Q: Partícula elemental que compone los protones y neutrones.', answer: 'QUARK' },
                { letter: 'R', question: 'Empieza por R: Desviación de un rayo de luz al pasar de un medio a otro.', answer: 'REFRACCION' },
                { letter: 'S', question: 'Empieza por S: La estrella central de nuestro sistema planetario.', answer: 'SOL' },
                { letter: 'T', question: 'Empieza por T: Instrumento óptico que permite observar objetos lejanos.', answer: 'TELESCOPIO' },
                { letter: 'U', question: 'Empieza por U: El séptimo planeta del sistema solar, conocido por estar inclinado de lado.', answer: 'URANO' },
                { letter: 'V', question: 'Empieza por V: Magnitud física que expresa el espacio recorrido por un móvil en la unidad de tiempo.', answer: 'VELOCIDAD' },
                { letter: 'X', question: 'Contiene la X: Tipo de radiación electromagnética, invisible para el ojo humano, usada en medicina.', answer: 'RAYOSX' },
                { letter: 'Y', question: 'Contiene la Y: Proceso por el cual los núcleos atómicos se combinan para formar núcleos más pesados.', answer: 'FUSION' },
                { letter: 'Z', question: 'Contiene la Z: Punto más alto en el cielo en relación con un observador.', answer: 'ZENIT' }
            ],
            historia_universal: [
                { letter: 'A', question: 'Empieza por A: Sistema político en la antigua Grecia donde el poder residía en los ciudadanos.', answer: 'DEMOCRACIA' },
                { letter: 'B', question: 'Empieza por B: Imperio que tuvo su capital en Constantinopla.', answer: 'BIZANTINO' },
                { letter: 'C', question: 'Empieza por C: Conflicto armado entre potencias cristianas y musulmanas en la Edad Media por el control de Tierra Santa.', answer: 'CRUZADAS' },
                { letter: 'D', question: 'Empieza por D: Título que ostentaban los gobernantes del Antiguo Egipto.', answer: 'FARAON' },
                { letter: 'E', question: 'Empieza por E: Pueblo germánico que saqueó Roma en el año 455.', answer: 'VANDALOS' },
                { letter: 'F', question: 'Empieza por F: Sistema social, económico y político predominante en Europa durante la Edad Media.', answer: 'FEUDALISMO' },
                { letter: 'G', question: 'Empieza por G: Conflicto bélico que tuvo lugar entre 1914 y 1918, también conocido como la Gran Guerra.', answer: 'GUERRA' },
                { letter: 'H', question: 'Empieza por H: Conjunto de primates homínidos que incluye al género Homo.', answer: 'HOMINIDOS' },
                { letter: 'I', question: 'Empieza por I: Vasto estado que abarcó gran parte de América del Sur, con capital en Cuzco.', answer: 'INCA' },
                { letter: 'J', question: 'Empieza por J: Emperador francés que conquistó gran parte de Europa a principios del siglo XIX.', answer: 'NAPOLEON' },
                { letter: 'L', question: 'Empieza por L: Soldado de infantería pesada de la antigua Roma.', answer: 'LEGIONARIO' },
                { letter: 'M', question: 'Empieza por M: Civilización precolombina que se desarrolló en el actual México, conocida por su escritura jeroglífica.', answer: 'MAYA' },
                { letter: 'N', question: 'Empieza por N: Movimiento político y social totalitario surgido en Alemania en el siglo XX.', answer: 'NAZISMO' },
                { letter: 'Ñ', question: 'Contiene la Ñ: Arma de asedio medieval usada para lanzar grandes proyectiles.', answer: 'TRABUCO' },
                { letter: 'O', question: 'Empieza por O: Imperio que dominó gran parte del sudeste de Europa, el oeste de Asia y el norte de África entre los siglos XIV y XX.', answer: 'OTOMANO' },
                { letter: 'P', question: 'Empieza por P: Conflicto armado que enfrentó a Atenas y Esparta en la antigua Grecia.', answer: 'PELOPONESO' },
                { letter: 'Q', question: 'Contiene la Q: Edificio destinado al culto en el Antiguo Egipto y otras culturas.', answer: 'TEMPLO' },
                { letter: 'R', question: 'Empieza por R: Movimiento cultural e intelectual que se desarrolló en Europa durante los siglos XV y XVI.', answer: 'RENACIMIENTO' },
                { letter: 'S', question: 'Empieza por S: Uno de los grandes filósofos de la antigua Grecia, maestro de Platón.', answer: 'SOCRATES' },
                { letter: 'T', question: 'Empieza por T: Ciudad legendaria de la antigua Grecia, escenario de una famosa guerra.', answer: 'TROYA' },
                { letter: 'U', question: 'Empieza por U: Organización internacional fundada después de la Segunda Guerra Mundial para mantener la paz.', answer: 'ONU' },
                { letter: 'V', question: 'Empieza por V: Pueblo nórdico que realizó incursiones y exploraciones por Europa entre los siglos VIII y XI.', answer: 'VIKINGOS' },
                { letter: 'X', question: 'Contiene la X: Expedición militar liderada por Alejandro Magno.', answer: 'CONQUISTA' },
                { letter: 'Y', question: 'Contiene la Y: Territorio bajo el dominio de un rey o una reina.', answer: 'REINO' },
                { letter: 'Z', question: 'Empieza por Z: Título que ostentaban los emperadores de Rusia.', answer: 'ZAR' }
            ],
            historia_chile: [
                { letter: 'A', question: 'Empieza por A: Capitán español considerado el fundador de Santiago de Chile.', answer: 'VALDIVIA' },
                { letter: 'B', question: 'Empieza por B: Héroe naval chileno, comandante de la Esmeralda en el combate de Iquique.', answer: 'PRAT' },
                { letter: 'C', question: 'Empieza por C: Período de la historia de Chile que sigue a la independencia y precede a la organización de la república.', answer: 'ANARQUIA' },
                { letter: 'D', question: 'Empieza por D: Proceso de gobierno autoritario que tuvo lugar en Chile entre 1973 y 1990.', answer: 'DICTADURA' },
                { letter: 'E', question: 'Empieza por E: Grupo de barcos de guerra que formó Chile para su independencia.', answer: 'ESCUADRA' },
                { letter: 'F', question: 'Empieza por F: Línea de defensa natural y militar establecida por los españoles en el río Biobío.', answer: 'FRONTERA' },
                { letter: 'G', question: 'Empieza por G: Conflicto que enfrentó a Chile contra la confederación Perú-Boliviana.', answer: 'YUNGAY' },
                { letter: 'H', question: 'Empieza por H: Padre de la Patria, lideró el proceso de independencia de Chile.', answer: 'OHIGGINS' },
                { letter: 'I', question: 'Empieza por I: Período prehispánico en Chile, donde habitaban pueblos originarios.', answer: 'INDIGENA' },
                { letter: 'J', question: 'Empieza por J: Nombre de la primera junta nacional de gobierno de Chile.', answer: 'JUNTA' },
                { letter: 'L', question: 'Empieza por L: Caudillo mapuche que lideró la resistencia contra los españoles en el siglo XVI.', answer: 'LAUTARO' },
                { letter: 'M', question: 'Empieza por M: Pueblo originario que habitó la zona centro-sur de Chile.', answer: 'MAPUCHE' },
                { letter: 'N', question: 'Empieza por N: Recurso natural cuya explotación fue clave para la economía chilena a fines del siglo XIX.', answer: 'SALITRE' },
                { letter: 'Ñ', question: 'Contiene la Ñ: Moneda de plata utilizada durante la época colonial en Chile.', answer: 'PESO' },
                { letter: 'O', question: 'Empieza por O: Ocupación militar de la región de la Araucanía por parte del Estado chileno.', answer: 'PACIFICACION' },
                { letter: 'P', question: 'Empieza por P: Conflicto bélico que enfrentó a Chile contra Perú y Bolivia entre 1879 y 1884.', answer: 'PACIFICO' },
                { letter: 'Q', question: 'Contiene la Q: Institución colonial encargada de la administración de justicia.', answer: 'AUDIENCIA' },
                { letter: 'R', question: 'Empieza por R: Período de la historia chilena entre 1831 y 1861 caracterizado por gobiernos autoritarios.', answer: 'CONSERVADORA' },
                { letter: 'S', question: 'Empieza por S: Presidente de Chile que gobernó entre 1970 y 1973.', answer: 'ALLENDE' },
                { letter: 'T', question: 'Empieza por T: Acuerdo firmado en 1984 que puso fin al conflicto del Beagle con Argentina.', answer: 'PAZ' },
                { letter: 'U', question: 'Empieza por U: División administrativa del territorio durante la colonia.', answer: 'CORREGIMIENTO' },
                { letter: 'V', question: 'Empieza por V: Ciudad y puerto principal de Chile, sede del Congreso Nacional.', answer: 'VALPARAISO' },
                { letter: 'X', question: 'Contiene la X: Proceso de expansión territorial de Chile hacia el sur.', answer: 'ANEXION' },
                { letter: 'Y', question: 'Contiene la Y: Yacimiento de cobre a rajo abierto más grande del mundo, ubicado en Chile.', answer: 'CHUQUICAMATA' },
                { letter: 'Z', question: 'Contiene la Z: Apellido del arquitecto que diseñó el Palacio de La Moneda.', answer: 'TOESCA' }
            ],
            mat_conceptos: [
                { letter: 'A', question: 'Empieza por A: Operación matemática que consiste en reunir varias cantidades en una sola.', answer: 'ADICION' },
                { letter: 'B', question: 'Empieza por B: Recta que divide un ángulo en dos partes iguales.', answer: 'BISECTRIZ' },
                { letter: 'C', question: 'Empieza por C: Número que se obtiene al dividir un número por otro.', answer: 'COCIENTE' },
                { letter: 'D', question: 'Empieza por D: Número que, en una fracción, indica cuántas partes iguales se han tomado de la unidad.', answer: 'NUMERADOR' },
                { letter: 'E', question: 'Empieza por E: Expresión matemática que indica una igualdad entre dos expresiones.', answer: 'ECUACION' },
                { letter: 'F', question: 'Empieza por F: Número que se expresa como el cociente de dos números enteros.', answer: 'FRACCION' },
                { letter: 'G', question: 'Empieza por G: Rama de las matemáticas que estudia las propiedades de las figuras en el plano o el espacio.', answer: 'GEOMETRIA' },
                { letter: 'H', question: 'Empieza por H: Lado de mayor longitud de un triángulo rectángulo.', answer: 'HIPOTENUSA' },
                { letter: 'I', question: 'Empieza por I: Número que no puede ser expresado como una fracción de dos enteros.', answer: 'IRRACIONAL' },
                { letter: 'J', question: 'Contiene la J: Conjunto ordenado de elementos.', answer: 'SECUENCIA' },
                { letter: 'L', question: 'Empieza por L: Función matemática que es la inversa de la exponencial.', answer: 'LOGARITMO' },
                { letter: 'M', question: 'Empieza por M: Operación que consiste en sumar un número tantas veces como indica otro número.', answer: 'MULTIPLICACION' },
                { letter: 'N', question: 'Empieza por N: Número que expresa una cantidad con relación a la unidad.', answer: 'NUMERO' },
                { letter: 'Ñ', question: 'Contiene la Ñ: Figura geométrica de cuatro lados.', answer: 'CUADRILATERO' },
                { letter: 'O', question: 'Empieza por O: Resultado de una operación matemática.', answer: 'PRODUCTO' },
                { letter: 'P', question: 'Empieza por P: Número que solo es divisible por sí mismo y por la unidad.', answer: 'PRIMO' },
                { letter: 'Q', question: 'Contiene la Q: Polígono de cinco lados.', answer: 'PENTAGONO' },
                { letter: 'R', question: 'Empieza por R: Operación inversa a la potenciación.', answer: 'RADICACION' },
                { letter: 'S', question: 'Empieza por S: Operación matemática que consiste en quitar una cantidad de otra.', answer: 'SUSTRACCION' },
                { letter: 'T', question: 'Empieza por T: Polígono de tres lados.', answer: 'TRIANGULO' },
                { letter: 'U', question: 'Empieza por U: Elemento neutro de la multiplicación.', answer: 'UNO' },
                { letter: 'V', question: 'Empieza por V: Símbolo que representa una cantidad que puede cambiar.', answer: 'VARIABLE' },
                { letter: 'X', question: 'Contiene la X: Número o cantidad desconocida que se representa con una letra.', answer: 'INCOGNITA' },
                { letter: 'Y', question: 'Contiene la Y: Proyección sobre el eje vertical en un sistema de coordenadas.', answer: 'ORDENADA' },
                { letter: 'Z', question: 'Contiene la Z: Cifra sin valor propio, que ocupa el lugar de las unidades vacías.', answer: 'CERO' }
            ],
            mat_geo: [
                { letter: 'A', question: 'Empieza por A: Medida de una superficie, expresada en unidades cuadradas.', answer: 'AREA' },
                { letter: 'B', question: 'Empieza por B: Expresión algebraica formada por la suma o resta de dos términos.', answer: 'BINOMIO' },
                { letter: 'C', question: 'Empieza por C: Sólido geométrico limitado por una superficie curva y dos planos paralelos que son sus bases.', answer: 'CILINDRO' },
                { letter: 'D', question: 'Empieza por D: Línea recta que une dos vértices no consecutivos de un polígono.', answer: 'DIAGONAL' },
                { letter: 'E', question: 'Empieza por E: Figura geométrica curva y cerrada, con dos ejes de simetría.', answer: 'ELIPSE' },
                { letter: 'F', question: 'Empieza por F: Proposición matemática demostrable a partir de axiomas o de otras proposiciones ya demostradas.', answer: 'TEOREMA' },
                { letter: 'G', question: 'Empieza por G: Nivel de un polinomio, determinado por el mayor exponente de sus variables.', answer: 'GRADO' },
                { letter: 'H', question: 'Empieza por H: Polígono de seis lados.', answer: 'HEXAGONO' },
                { letter: 'I', question: 'Empieza por I: Que no tiene fin o término.', answer: 'INFINITO' },
                { letter: 'J', question: 'Contiene la J: Conjunto de puntos en un plano que equidistan de un punto fijo llamado centro.', answer: 'CIRCUNFERENCIA' },
                { letter: 'L', question: 'Empieza por L: Límite que se aproxima a un valor sin llegar a tocarlo.', answer: 'ASINTOTA' },
                { letter: 'M', question: 'Empieza por M: Expresión algebraica que consta de un solo término.', answer: 'MONOMIO' },
                { letter: 'N', question: 'Empieza por N: Número entero que no es positivo.', answer: 'NEGATIVO' },
                { letter: 'Ñ', question: 'Contiene la Ñ: Ángulo que mide menos de 90 grados.', answer: 'AGUDO' },
                { letter: 'O', question: 'Empieza por O: Polígono de ocho lados.', answer: 'OCTOGONO' },
                { letter: 'P', question: 'Empieza por P: Línea recta que corta a otra perpendicularmente.', answer: 'PERPENDICULAR' },
                { letter: 'Q', question: 'Contiene la Q: Figura geométrica plana de cuatro lados iguales y cuatro ángulos rectos.', answer: 'CUADRADO' },
                { letter: 'R', question: 'Empieza por R: Polígono cuyos lados y ángulos interiores son iguales entre sí.', answer: 'REGULAR' },
                { letter: 'S', question: 'Empieza por S: Dos o más ecuaciones con varias incógnitas que deben satisfacerse simultáneamente.', answer: 'SISTEMA' },
                { letter: 'T', question: 'Empieza por T: Expresión algebraica que consta de tres términos.', answer: 'TRINOMIO' },
                { letter: 'U', question: 'Empieza por U: Que tiene una sola variable.', answer: 'UNIVARIABLE' },
                { letter: 'V', question: 'Empieza por V: Punto donde se unen dos o más lados de una figura geométrica.', answer: 'VERTICE' },
                { letter: 'X', question: 'Contiene la X: Parte literal de un término algebraico.', answer: 'VARIABLE' },
                { letter: 'Y', question: 'Contiene la Y: Proposición que se toma como base para un razonamiento.', answer: 'AXIOMA' },
                { letter: 'Z', question: 'Contiene la Z: Sólido geométrico formado por una superficie curva y una base circular.', answer: 'CONO' }
            ],
            leng_vocabulario: [
                { letter: 'A', question: 'Empieza por A: Dicho de una persona: Que puede vivir tanto en tierra como en agua.', answer: 'ANFIBIO' },
                { letter: 'B', question: 'Empieza por B: Aficionado a los libros y a la lectura.', answer: 'BIBLIOFILO' },
                { letter: 'C', question: 'Empieza por C: Dicho de una cosa: Que puede romperse con facilidad.', answer: 'CRISTALINO' },
                { letter: 'D', question: 'Empieza por D: Conversación entre dos o más personas que exponen sus ideas y comentarios de forma alternativa.', answer: 'DIALOGO' },
                { letter: 'E', question: 'Empieza por E: Que dura poco tiempo.', answer: 'EFIMERO' },
                { letter: 'F', question: 'Empieza por F: Que finge o aparenta lo que no es o no siente.', answer: 'FALSO' },
                { letter: 'G', question: 'Empieza por G: Dicho de una persona: Que come con exceso y con ansia.', answer: 'GLOTON' },
                { letter: 'H', question: 'Empieza por H: Dicho de una cosa: Que está formada por elementos de distinta naturaleza.', answer: 'HETEROGENEO' },
                { letter: 'I', question: 'Empieza por I: Que no se puede borrar o quitar.', answer: 'INDELEBLE' },
                { letter: 'J', question: 'Empieza por J: Alegría o gozo muy intenso.', answer: 'JUBILO' },
                { letter: 'L', question: 'Empieza por L: Que habla mucho.', answer: 'LOCUAZ' },
                { letter: 'M', question: 'Empieza por M: Que siente tristeza o melancolía.', answer: 'MELANCOLICO' },
                { letter: 'N', question: 'Empieza por N: Que siente una gran añoranza por el pasado.', answer: 'NOSTALGICO' },
                { letter: 'Ñ', question: 'Contiene la Ñ: Que es pequeño o de poca importancia.', answer: 'MINIMO' },
                { letter: 'O', question: 'Empieza por O: Dicho de una cosa: Que es muy pesada.', answer: 'ONEROSO' },
                { letter: 'P', question: 'Empieza por P: Que es el primero en una actividad o en un campo de conocimiento.', answer: 'PIONERO' },
                { letter: 'Q', question: 'Contiene la Q: Relativo a la química.', answer: 'QUIMICO' },
                { letter: 'R', question: 'Empieza por R: Que se niega a hacer algo.', answer: 'REACIO' },
                { letter: 'S', question: 'Empieza por S: Que es astuto y prudente.', answer: 'SAGAZ' },
                { letter: 'T', question: 'Empieza por T: Que es obstinado y tenaz.', answer: 'TERCO' },
                { letter: 'U', question: 'Empieza por U: Que es el primero y único de su especie.', answer: 'UNICO' },
                { letter: 'V', question: 'Empieza por V: Que es rápido y ligero.', answer: 'VELOZ' },
                { letter: 'X', question: 'Contiene la X: Que es abundante y copioso.', answer: 'EXUBERANTE' },
                { letter: 'Y', question: 'Contiene la Y: Que está uno al lado del otro.', answer: 'ADYACENTE' },
                { letter: 'Z', question: 'Contiene la Z: Dicho de una persona: Que es muy hábil y astuta.', answer: 'ZORRO' }
            ],
            leng_teoria: [
                { letter: 'A', question: 'Empieza por A: Repetición de uno o varios sonidos dentro de una misma palabra o frase.', answer: 'ALITERACION' },
                { letter: 'B', question: 'Empieza por B: Cada una de las dos partes en que se divide un poema.', answer: 'BIPARTITO' },
                { letter: 'C', question: 'Empieza por C: Comparación o semejanza entre dos elementos.', answer: 'COMPARACION' },
                { letter: 'D', question: 'Empieza por D: Final de una obra literaria, especialmente de un drama.', answer: 'DESENLACE' },
                { letter: 'E', question: 'Empieza por E: Composición poética que lamenta la muerte de una persona.', answer: 'ELEGIA' },
                { letter: 'F', question: 'Empieza por F: Tipo de texto que relata hechos imaginarios.', answer: 'FICCION' },
                { letter: 'G', question: 'Empieza por G: Conjunto de obras que comparten ciertas características de forma y contenido.', answer: 'GENERO' },
                { letter: 'H', question: 'Empieza por H: Exageración de un hecho, una circunstancia o un relato.', answer: 'HIPERBOLE' },
                { letter: 'I', question: 'Empieza por I: Alteración del orden normal de las palabras en una oración.', answer: 'HIPERBATON' },
                { letter: 'J', question: 'Contiene la J: Obra literaria que critica o ridiculiza a personas o instituciones.', answer: 'SATIRA' },
                { letter: 'L', question: 'Empieza por L: Género literario que expresa sentimientos y emociones.', answer: 'LIRICA' },
                { letter: 'M', question: 'Empieza por M: Figura retórica que consiste en identificar un término real con uno imaginario.', answer: 'METAFORA' },
                { letter: 'N', question: 'Empieza por N: Voz que cuenta la historia en una obra literaria.', answer: 'NARRADOR' },
                { letter: 'Ñ', question: 'Contiene la Ñ: Personaje principal de una obra literaria.', answer: 'PROTAGONISTA' },
                { letter: 'O', question: 'Empieza por O: Figura retórica que consiste en la imitación de sonidos reales.', answer: 'ONOMATOPEYA' },
                { letter: 'P', question: 'Empieza por P: Atribución de cualidades humanas a seres inanimados o animales.', answer: 'PERSONIFICACION' },
                { letter: 'Q', question: 'Contiene la Q: Composición poética de cuatro versos de arte menor.', answer: 'COPLA' },
                { letter: 'R', question: 'Empieza por R: Repetición de sonidos al final de los versos de un poema.', answer: 'RIMA' },
                { letter: 'S', question: 'Empieza por S: Figura retórica que consiste en la comparación de dos términos.', answer: 'SIMIL' },
                { letter: 'T', question: 'Empieza por T: Asunto o materia de la que trata una obra.', answer: 'TEMA' },
                { letter: 'U', question: 'Empieza por U: Que tiene una sola sílaba.', answer: 'MONOSILABO' },
                { letter: 'V', question: 'Empieza por V: Cada una de las líneas de un poema.', answer: 'VERSO' },
                { letter: 'X', question: 'Contiene la X: Descubrimiento de la situación en una tragedia.', answer: 'ANAGNORISIS' },
                { letter: 'Y', question: 'Contiene la Y: Poema lírico de tema amoroso y pastoril.', answer: 'EGLOGA' },
                { letter: 'Z', question: 'Contiene la Z: Figura retórica que consiste en cruzar dos estructuras gramaticales.', answer: 'QUIASMO' }
            ]
        };

        let players = [];
        let currentPlayerIndex = 0;
        let gameSettings = {};
        let overallGameActive = false;

        class Player {
            constructor(id, name, roscoData) {
                this.id = id;
                this.name = name || `Jugador ${id}`;
                this.useTimer = gameSettings.useTimer;
                this.timeLeft = gameSettings.customTime;
                this.timerId = null;
                this.isFinished = false;
                this.isRevealingAnswer = false;
                this.roscoData = JSON.parse(JSON.stringify(roscoData)).map(item => ({ ...item, status: 'unanswered' }));
                this.currentIndex = -1;
                this.score = { correct: 0, incorrect: 0 };
                this.createUI();
            }

            createUI() {
                this.container = document.createElement('div');
                this.container.id = `player-container-${this.id}`;
                this.container.className = 'player-container bg-themed-secondary rounded-2xl p-4';
                this.container.innerHTML = `
                    <h2 class="text-xl font-bold text-center truncate">${this.name}</h2>
                    <div class="flex justify-around text-lg my-2">
                        <span>Aciertos: <span class="font-bold correct-count text-green-400">0</span></span>
                        <span>Errores: <span class="font-bold incorrect-count text-red-400">0</span></span>
                    </div>
                    ${this.useTimer ? `<div class="text-center text-2xl font-mono timer">${this.formatTime()}</div>` : ''}
                    <div class="rosco-container">
                        <div class="central-display absolute inset-0 m-auto w-3/4 h-3/4 bg-gray-700 rounded-full flex flex-col items-center justify-center p-2 text-center shadow-inner">
                            <p id="p${this.id}-question-letter" class="text-md font-semibold text-themed-accent">Elige una letra</p>
                            <p id="p${this.id}-question-text" class="text-base question-text">Presiona una letra para empezar</p>
                        </div>
                    </div>
                `;
                gameBoard.appendChild(this.container);
                this.container.addEventListener('click', () => switchToPlayer(this.id));
                this.roscoContainer = this.container.querySelector('.rosco-container');
                this.correctCountEl = this.container.querySelector('.correct-count');
                this.incorrectCountEl = this.container.querySelector('.incorrect-count');
                this.questionLetterEl = this.container.querySelector(`#p${this.id}-question-letter`);
                this.questionTextEl = this.container.querySelector(`#p${this.id}-question-text`);
                this.timerEl = this.container.querySelector('.timer');
            }
            
            drawRosco() {
                const radius = this.roscoContainer.offsetWidth / 2 * 0.8;
                if (radius === 0) return;
                
                const angleStep = (2 * Math.PI) / this.roscoData.length;
                const centerX = this.roscoContainer.offsetWidth / 2;
                const centerY = this.roscoContainer.offsetHeight / 2;
                
                this.roscoData.forEach((item, i) => {
                    const angle = i * angleStep - (Math.PI / 2);
                    const x = radius * Math.cos(angle) + centerX;
                    const y = radius * Math.sin(angle) + centerY;
                    
                    const cell = document.createElement('div');
                    cell.id = `p${this.id}-letter-${item.letter}`;
                    cell.className = 'letter-cell';
                    cell.textContent = item.letter;
                    
                    // Centrado perfecto de las celdas
                    cell.style.left = `${x}px`;
                    cell.style.top = `${y}px`;
                    cell.style.transform = 'translate(-50%, -50%)';
                    
                    // Añadir evento de click para seleccionar letra
                    cell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (currentPlayerIndex === this.id - 1) {
                            this.jumpToLetter(item.letter.toLowerCase());
                        }
                    });
                    
                    this.roscoContainer.appendChild(cell);
                });
            }

            startTurn() {
                if (this.isFinished) return;
                this.container.classList.add('active');
                if (this.useTimer && !this.timerId) {
                    this.timerId = setInterval(() => this.updateTimer(), 1000);
                }
            }

            endTurn() {
                this.container.classList.remove('active');
                if (this.timerId) {
                    clearInterval(this.timerId);
                    this.timerId = null;
                }
            }

            updateTimer() {
                this.timeLeft--;
                if(this.timerEl) this.timerEl.textContent = this.formatTime();
                if (this.timeLeft <= 0) {
                    sound.timesUp();
                    this.isFinished = true;
                    this.endTurn();
                    checkEndGame();
                }
            }
            
            formatTime(){
                const minutes = String(Math.floor(this.timeLeft / 60)).padStart(2, '0');
                const seconds = String(this.timeLeft % 60).padStart(2, '0');
                return `${minutes}:${seconds}`;
            }
            
            updateActiveLetter() {
                this.container.querySelectorAll('.letter-cell.active').forEach(c => c.classList.remove('active'));
                if (this.currentIndex !== -1) {
                    const currentItem = this.roscoData[this.currentIndex];
                    this.questionLetterEl.textContent = currentItem.question.split(':')[0];
                    this.questionTextEl.textContent = currentItem.question.split(':')[1].trim();
                    const currentCell = this.container.querySelector(`#p${this.id}-letter-${currentItem.letter}`);
                    if (currentCell) {
                        currentCell.classList.add('active');
                        sound.letterSelect(); // Nuevo sonido al seleccionar
                        speak(currentItem.letter);
                    }
                }
            }
            
            jumpToLetter(letter) {
                const targetIndex = this.roscoData.findIndex(item => item.letter.toLowerCase() === letter);
                if (targetIndex !== -1) {
                    this.currentIndex = targetIndex;
                    this.updateActiveLetter();
                }
            }

            processAnswer(status) {
                if (this.isFinished || this.isRevealingAnswer || this.currentIndex === -1) return;
                const currentItem = this.roscoData[this.currentIndex];
                
                currentItem.status = status;
                const cell = this.container.querySelector(`#p${this.id}-letter-${currentItem.letter}`);
                cell.classList.remove('active', 'pending', 'correct', 'incorrect');
                cell.classList.add(status);
                if (sound[status]) sound[status]();

                if (status === 'correct') {
                    speak(currentItem.answer);
                }

                this.updateScore();

                this.currentIndex = -1;
                
                if (status === 'correct') {
                    this.isRevealingAnswer = true;
                    this.questionLetterEl.textContent = '¡Correcto!';
                    this.questionTextEl.textContent = currentItem.answer.toUpperCase();
                    this.questionTextEl.classList.add('text-green-400', 'font-bold');
                    setTimeout(() => {
                        this.questionTextEl.classList.remove('text-green-400', 'font-bold');
                        this.isRevealingAnswer = false;
                        this.questionLetterEl.textContent = 'Elige otra letra';
                        this.questionTextEl.textContent = '';
                        this.checkCompletion();
                    }, 2000);
                } else if (status === 'incorrect' && gameSettings.revealAnswer) {
                    this.isRevealingAnswer = true;
                    this.questionLetterEl.textContent = 'Respuesta correcta:';
                    this.questionTextEl.textContent = currentItem.answer.toUpperCase();
                    this.questionTextEl.classList.add('text-red-400', 'font-bold');
                    setTimeout(() => {
                        this.questionTextEl.classList.remove('text-red-400', 'font-bold');
                        this.isRevealingAnswer = false;
                        this.questionLetterEl.textContent = 'Elige otra letra';
                        this.questionTextEl.textContent = '';
                        this.checkCompletion();
                    }, 2500);
                } else {
                    this.questionLetterEl.textContent = 'Elige otra letra';
                    this.questionTextEl.textContent = '';
                    this.checkCompletion();
                }
            }
            
            checkCompletion() {
                 const remaining = this.roscoData.filter(item => item.status === 'unanswered' || item.status === 'pending').length;
                if (remaining === 0) {
                    this.isFinished = true;
                    this.endTurn();
                    checkEndGame();
                }
            }

            updateScore() {
                this.score.correct = this.roscoData.filter(item => item.status === 'correct').length;
                this.score.incorrect = this.roscoData.filter(item => item.status === 'incorrect').length;
                this.correctCountEl.textContent = this.score.correct;
                this.incorrectCountEl.textContent = this.score.incorrect;
            }
        }
        
        function updatePlayerNameInputs() {
            const count = parseInt(numPlayersSelect.value);
            playerNamesContainer.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `player-name-${i}`;
                input.placeholder = `Nombre Jugador ${i}`;
                input.className = 'w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white';
                playerNamesContainer.appendChild(input);
            }
        }

            async function startGame() {
            gameSettings = {
                numPlayers: parseInt(numPlayersSelect.value),
                useTimer: useTimerCheckbox.checked,
                useSound: useSoundCheckbox.checked,
                revealAnswer: revealAnswerCheckbox.checked,
                customTime: parseInt(customTimeInput.value) || 150,
                title: activityTitleInput.value,
                playerNames: []
            };

            // Inicializar audio con los nuevos sintetizadores
            await initAudio();            const selectedRosco = roscoSelector.value;
            let customRoscoData;

            if (selectedRosco === 'upload') {
                const file = csvFileInput.files[0];
                if (!file) {
                    alert("Por favor, selecciona un archivo CSV para subir o elige un rosco precargado.");
                    return;
                }
                try {
                    customRoscoData = await parseCSV(file);
                } catch (error) {
                    alert(`Error al leer el archivo de preguntas: ${error.message}\n\nSe usará el rosco por defecto.`);
                    customRoscoData = PRELOADED_ROSCOS.default;
                }
            } else {
                customRoscoData = PRELOADED_ROSCOS[selectedRosco];
            }
            
            for (let i = 1; i <= gameSettings.numPlayers; i++) {
                const input = document.getElementById(`player-name-${i}`);
                gameSettings.playerNames.push(input.value);
            }
            
            if (gameSettings.title) {
                gameTitle.textContent = gameSettings.title;
                gameTitle.classList.remove('hidden');
            } else {
                gameTitle.classList.add('hidden');
            }

            setupScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            downloadBtn.classList.add('hidden');
            gameBoard.innerHTML = '';
            
            if (gameSettings.numPlayers === 1) {
                gameBoard.classList.add('md:max-w-xl', 'mx-auto');
                gameBoard.classList.remove('md:grid-cols-2');
            } else {
                gameBoard.classList.remove('md:max-w-xl', 'mx-auto');
                if (gameSettings.numPlayers >= 2) {
                    gameBoard.classList.add('md:grid-cols-2');
                }
            }

            players = [];
            for (let i = 0; i < gameSettings.numPlayers; i++) {
                players.push(new Player(i + 1, gameSettings.playerNames[i], customRoscoData));
            }

            setTimeout(() => {
                players.forEach(p => p.drawRosco());
                currentPlayerIndex = 0;
                overallGameActive = true;
                if (players.length > 0) {
                    switchToPlayer(1);
                    sound.gameStart(); // Sonido de inicio
                }
                applyFontSize(fontSizeSlider.value);
            }, 100);
        }
        
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const text = event.target.result;
                        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                        if (lines.length < 2) {
                            return reject(new Error("El archivo CSV está vacío o no tiene suficientes filas."));
                        }
                        
                        const headers = lines[0].split(';').map(h => h.trim().replace(/"/g, '').toLowerCase());
                        
                        const letterIndex = headers.indexOf('letra');
                        const questionIndex = headers.findIndex(h => h.includes('pregunta'));
                        const answerIndex = headers.indexOf('respuesta');

                        if (letterIndex === -1 || questionIndex === -1 || answerIndex === -1) {
                            return reject(new Error("El archivo CSV debe contener las columnas: 'Letra', 'Pregunta (o Pista)', y 'Respuesta'."));
                        }

                        const data = [];
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(';');
                            if (values.length > Math.max(letterIndex, questionIndex, answerIndex)) {
                                const letterRaw = values[letterIndex]?.trim().replace(/"/g, '');
                                const question = values[questionIndex]?.trim().replace(/"/g, '');
                                const answer = values[answerIndex]?.trim().replace(/"/g, '');

                                if (letterRaw && question && answer) {
                                    const letter = letterRaw.toUpperCase();
                                    if (letter.length === 1 && "ABCDEFGHIJKLMNÑOPQRSTUVWXYZ".includes(letter)) {
                                        data.push({ letter: letter, question, answer });
                                    }
                                }
                            }
                        }
                        
                        if (data.length === 0) {
                            return reject(new Error("No se encontraron datos válidos en el archivo. Verifique el formato y que el separador sea punto y coma (;)."));
                        }
                        
                        data.sort((a, b) => a.letter.localeCompare(b.letter, 'es', { sensitivity: 'base' }));

                        resolve(data);
                    } catch (e) {
                        reject(new Error("Ocurrió un error inesperado al procesar el archivo."));
                    }
                };
                reader.onerror = () => {
                    reject(new Error("No se pudo leer el archivo."));
                };
                reader.readAsText(file, 'UTF-8');
            });
        }

        function switchToPlayer(playerId) {
            if (!overallGameActive) return;
            const newPlayerIndex = players.findIndex(p => p.id === playerId);
            if (newPlayerIndex === -1 || (players.length > 1 && newPlayerIndex === currentPlayerIndex)) return;
            if (players[currentPlayerIndex]) players[currentPlayerIndex].endTurn();
            currentPlayerIndex = newPlayerIndex;
            if (players[currentPlayerIndex]) players[currentPlayerIndex].startTurn();
        }

        function checkEndGame() {
            const allFinished = players.every(p => p.isFinished);
            if (allFinished) {
                overallGameActive = false;
                downloadBtn.classList.remove('hidden');
                if (players[currentPlayerIndex]) players[currentPlayerIndex].container.classList.remove('active');
            }
        }

        function handleKeyPress(e) {
            if (!overallGameActive || players.length === 0) return;
            const activePlayer = players[currentPlayerIndex];
            if (activePlayer.isFinished || activePlayer.isRevealingAnswer) return;

            const key = e.key.toLowerCase();

            if ((key >= 'a' && key <= 'z') || key === 'ñ') {
                activePlayer.jumpToLetter(key);
                return;
            }

            let status = '';
            if (key === '1') status = 'correct';
            else if (key === '2') status = 'incorrect';
            else if (key === ' ') { e.preventDefault(); status = 'pending'; }
            else return;
            
            activePlayer.processAnswer(status);
        }
        
        function downloadResults() {
            let content = `Resultados de: ${gameSettings.title || 'Rosco de Pasapalabra'}\n===================================\n\n`;
            players.forEach(player => {
                content += `--- ${player.name.toUpperCase()} ---\nAciertos: ${player.score.correct}\nErrores: ${player.score.incorrect}\n\n`;
                player.roscoData.forEach(item => { content += `Letra ${item.letter}: ${item.status.toUpperCase()}\n`; });
                content += `\n-------------------------\n\n`;
            });
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'resultados_pasapalabra.txt';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function downloadTemplate() {
            const headers = '"Letra";"Pregunta (o Pista)";"Respuesta"';
            const rows = roscoDataTemplate.map(item => `"${item.letter}";"Con la ${item.letter}, ...";"Palabra Correcta"`);
            const csvContent = "\uFEFF" + [headers, ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'plantilla_pasapalabra.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showSetup() {
            overallGameActive = false;
            gameContainer.classList.add('hidden');
            setupScreen.classList.remove('hidden');
        }

        function setTheme(theme) {
            document.body.className = theme;
        }
        
        function toggleTimeInput() {
            timeInputContainer.classList.toggle('hidden', !useTimerCheckbox.checked);
        }
        
        function applyScale(scale) {
            gameBoard.style.transform = `scale(${scale})`;
        }

        function applyFontSize(size) {
            document.querySelectorAll('.question-text').forEach(el => {
                el.style.fontSize = `${size}px`;
            });
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', startGame);
        document.addEventListener('keydown', handleKeyPress);
        downloadBtn.addEventListener('click', downloadResults);
        backToSetupBtn.addEventListener('click', showSetup);
        numPlayersSelect.addEventListener('change', updatePlayerNameInputs);
        downloadTemplateBtn.addEventListener('click', downloadTemplate);
        themeSelector.addEventListener('change', (e) => setTheme(e.target.value));
        useTimerCheckbox.addEventListener('change', toggleTimeInput);
        instructionsToggle.addEventListener('click', () => {
            instructionsPanel.classList.toggle('open');
            const isOpen = instructionsPanel.classList.contains('open');
            instructionsIcon.textContent = isOpen ? ' − ' : ' + ';
        });
        scaleSlider.addEventListener('input', (e) => applyScale(e.target.value));
        fontSizeSlider.addEventListener('input', (e) => applyFontSize(e.target.value));
        roscoSelector.addEventListener('change', (e) => {
            csvUploadContainer.classList.toggle('hidden', e.target.value !== 'upload');
        });


        // --- Init ---
        updatePlayerNameInputs();
        setTheme(themeSelector.value);
        toggleTimeInput();
    });
    </script>

    <!-- Mobile Menu Toggle Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');

            mobileMenuButton.addEventListener('click', function() {
                mobileMenu.classList.toggle('hidden');
            });

            // Close mobile menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!mobileMenuButton.contains(event.target) && !mobileMenu.contains(event.target)) {
                    mobileMenu.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
