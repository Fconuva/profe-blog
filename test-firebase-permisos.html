<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firebase - Diagn√≥stico de Permisos</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold mb-6 text-indigo-600">üîç Diagn√≥stico Firebase</h1>
        
        <div id="results" class="space-y-4">
            <div class="p-4 bg-blue-50 border border-blue-200 rounded">
                <p class="text-blue-800">Iniciando diagn√≥stico...</p>
            </div>
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-bold mb-4">üìã Pasos para Solucionar</h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                <li>Ve a <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 underline">Firebase Console</a></li>
                <li>Selecciona tu proyecto: <strong>profefranciscopancho</strong></li>
                <li>Ve a <strong>Realtime Database</strong> ‚Üí <strong>Rules</strong></li>
                <li>Copia y pega las reglas desde <code>firebase-rules.json</code></li>
                <li>Haz click en <strong>Publicar</strong></li>
                <li>Recarga esta p√°gina y verifica nuevamente</li>
            </ol>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const resultsDiv = document.getElementById('results');

        function addResult(message, type = 'info') {
            const colors = {
                success: 'bg-green-50 border-green-200 text-green-800',
                error: 'bg-red-50 border-red-200 text-red-800',
                warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
                info: 'bg-blue-50 border-blue-200 text-blue-800'
            };

            const icon = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            const div = document.createElement('div');
            div.className = `p-4 border rounded ${colors[type]}`;
            div.innerHTML = `<p><strong>${icon[type]}</strong> ${message}</p>`;
            resultsDiv.appendChild(div);
        }

        async function testFirebase() {
            resultsDiv.innerHTML = '';
            
            try {
                // 1. Test Firebase Initialization
                addResult('Paso 1: Inicializando Firebase...', 'info');
                
                const firebaseConfig = {
                    apiKey: "AIzaSyCzN4xNEE_hKshXbsVqLhWSnzet1pHwRh8",
                    authDomain: "profefranciscopancho.firebaseapp.com",
                    databaseURL: "https://profefranciscopancho-default-rtdb.firebaseio.com",
                    projectId: "profefranciscopancho",
                    storageBucket: "profefranciscopancho.firebasestorage.app",
                    messagingSenderId: "585856906940",
                    appId: "1:585856906940:web:3e48c7aef77e45e4f97f10",
                    measurementId: "G-81H94PBDCJ"
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const database = firebase.database();
                addResult('Firebase inicializado correctamente', 'success');

                // 2. Test Database Connection
                addResult('Paso 2: Verificando conexi√≥n a Realtime Database...', 'info');
                const connectedRef = database.ref('.info/connected');
                
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error('Timeout')), 5000);
                    connectedRef.once('value', (snapshot) => {
                        clearTimeout(timeout);
                        if (snapshot.val() === true) {
                            addResult('Conexi√≥n a Realtime Database establecida', 'success');
                            resolve();
                        } else {
                            addResult('No hay conexi√≥n a Realtime Database', 'error');
                            reject(new Error('No conectado'));
                        }
                    });
                });

                // 3. Test Read Permission on /users
                addResult('Paso 3: Probando permisos de lectura en /users...', 'info');
                try {
                    const usersSnapshot = await database.ref('users').limitToFirst(1).once('value');
                    if (usersSnapshot.exists()) {
                        addResult('‚úÖ √âXITO: Permisos de lectura en /users funcionando correctamente', 'success');
                        addResult(`Se encontr√≥ ${Object.keys(usersSnapshot.val()).length} registro(s) de prueba`, 'success');
                    } else {
                        addResult('‚ö†Ô∏è ADVERTENCIA: No hay datos en /users, pero los permisos funcionan', 'warning');
                        addResult('Esto es normal si a√∫n no has creado usuarios', 'info');
                    }
                } catch (readError) {
                    addResult('‚ùå ERROR DE PERMISOS: No se puede leer /users', 'error');
                    addResult(`Detalle: ${readError.message}`, 'error');
                    addResult('SOLUCI√ìN: Debes aplicar las reglas de firebase-rules.json en Firebase Console', 'warning');
                    throw readError;
                }

                // 4. Test Write Permission
                addResult('Paso 4: Probando permisos de escritura en /analytics...', 'info');
                try {
                    const testData = {
                        test: true,
                        timestamp: new Date().toISOString(),
                        message: 'Test de diagn√≥stico'
                    };
                    await database.ref('analytics/diagnostico').set(testData);
                    addResult('‚úÖ √âXITO: Permisos de escritura funcionando correctamente', 'success');
                } catch (writeError) {
                    addResult('‚ùå ERROR DE PERMISOS: No se puede escribir en la base de datos', 'error');
                    addResult(`Detalle: ${writeError.message}`, 'error');
                    throw writeError;
                }

                // 5. Summary
                addResult('üéâ DIAGN√ìSTICO COMPLETO: Todos los permisos est√°n configurados correctamente', 'success');
                addResult('El sistema de login deber√≠a funcionar sin problemas', 'success');

            } catch (error) {
                addResult('‚ùå DIAGN√ìSTICO FALLIDO: Hay problemas con la configuraci√≥n de Firebase', 'error');
                addResult(`Error principal: ${error.message}`, 'error');
                addResult('Por favor, sigue los pasos de soluci√≥n arriba para aplicar las reglas correctamente', 'warning');
            }
        }

        // Run test on page load
        testFirebase();
    </script>
</body>
</html>
